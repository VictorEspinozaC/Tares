<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tablero Tareas</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ===== Modern light UI (tipo Lovable) ===== */
    :root {
      --bg: #f4f6fb;
      --panel: #ffffff;
      --panel2: #f8fafc;
      --muted: #64748b;
      --text: #0f172a;
      --accent: #2f7cff;
      --accent2: #00c2ff;

      --danger: #ef4444;
      --ok: #16a34a;
      --warn: #f59e0b;

      --border: rgba(15, 23, 42, .10);
      --shadow: 0 10px 30px rgba(2, 6, 23, .08);
      --shadow-lg: 0 20px 50px rgba(2, 6, 23, .15);
      --shadow-glass: 0 8px 32px rgba(31, 38, 135, .15);
      --radius: 16px;

      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background:
        radial-gradient(900px 600px at 15% -10%, rgba(47, 124, 255, .18), transparent 60%),
        radial-gradient(900px 600px at 95% -10%, rgba(0, 194, 255, .12), transparent 60%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      background: rgba(244, 246, 251, .85);
      border-bottom: 1px solid rgba(255, 255, 255, .30);
      box-shadow: var(--shadow-glass);
    }

    .topbar {
      max-width: 1400px;
      margin: 0 auto;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 260px;
    }

    .logo {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(47, 124, 255, .95), rgba(0, 194, 255, .75));
      box-shadow: var(--shadow);
    }

    .brand .txt {
      display: flex;
      flex-direction: column;
      gap: 2px;
      line-height: 1.1;
    }

    .brand .txt strong {
      font-size: 14px;
      letter-spacing: .2px;
    }

    .brand .txt span {
      font-size: 12px;
      color: var(--muted);
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .search {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .9);
      min-width: min(420px, 100%);
      box-shadow: 0 6px 18px rgba(2, 6, 23, .05);
    }

    .search input {
      width: 320px;
      max-width: 100%;
      background: transparent;
      border: 0;
      outline: none;
      color: var(--text);
      font-size: 13px;
    }

    .search .hint {
      font-size: 11px;
      color: var(--muted);
      border: 1px solid var(--border);
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(2, 6, 23, .03);
      white-space: nowrap;
    }

    button {
      border: 1px solid transparent;
      cursor: pointer;
      user-select: none;
      border-radius: 12px;
      padding: 9px 11px;
      font-weight: 700;
      font-size: 13px;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    button:active {
      transform: translateY(1px);
    }

    button:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
    }

    .primary {
      background: linear-gradient(135deg, rgba(47, 124, 255, .95), rgba(0, 194, 255, .75));
      color: #061021;
      box-shadow: 0 10px 30px rgba(47, 124, 255, .30);
    }

    .primary:hover {
      box-shadow: 0 15px 40px rgba(47, 124, 255, .40);
    }

    .secondary {
      background: rgba(255, 255, 255, .95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, .40);
      color: var(--text);
      font-weight: 650;
      box-shadow: 0 8px 25px rgba(2, 6, 23, .08);
    }

    .secondary:hover {
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 12px 35px rgba(2, 6, 23, .12);
    }

    .danger-btn {
      background: rgba(239, 68, 68, .12);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(239, 68, 68, .35);
      color: #991b1b;
      box-shadow: 0 8px 25px rgba(239, 68, 68, .10);
    }

    .segmented {
      display: flex;
      border: 1px solid rgba(255, 255, 255, .35);
      border-radius: 14px;
      overflow: hidden;
      background: rgba(255, 255, 255, .95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(2, 6, 23, .08);
    }

    .segmented button {
      border-radius: 0;
      border: 0;
      background: transparent;
      color: var(--muted);
      padding: 9px 12px;
      font-weight: 800;
    }

    .segmented button.active {
      background: rgba(2, 6, 23, .04);
      color: var(--text);
    }

    /* ===== Layout ===== */
    .layout {
      max-width: 1400px;
      margin: 0 auto;
      padding: 14px 16px 28px;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 12px;
    }

    @media (max-width: 980px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .search {
        min-width: 100%;
      }

      .search input {
        width: 100%;
      }
    }

    .sidebar {
      background: rgba(255, 255, 255, .95);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      height: fit-content;
    }

    .sb-hd {
      padding: 12px 14px;
      border-bottom: 1px solid rgba(47, 124, 255, .25);
      background: linear-gradient(180deg, rgba(47, 124, 255, .08), rgba(47, 124, 255, .03));
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .sb-hd strong {
      color: rgba(47, 124, 255, .95);
      font-weight: 800;
    }

    .sb-hd strong {
      font-size: 13px;
    }

    .sb-bd {
      padding: 10px;
      display: grid;
      gap: 10px;
    }

    .ws-list {
      display: grid;
      gap: 8px;
    }

    .ws-item {
      padding: 12px 14px;
      border-radius: 16px;
      border: 1.5px solid rgba(255, 255, 255, .35);
      background: rgba(255, 255, 255, .92);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 6px 20px rgba(2, 6, 23, .06);
      position: relative;
    }

    .ws-item:hover {
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 10px 30px rgba(2, 6, 23, .10);
      transform: translateX(2px);
    }

    .ws-item .name {
      font-size: 13px;
      font-weight: 800;
      line-height: 1.2;
      flex: 1;
    }

    .ws-item small {
      color: var(--muted);
      font-size: 11px;
    }

    .ws-item.active {
      border-color: rgba(47, 124, 255, .70);
      box-shadow: 0 10px 40px rgba(47, 124, 255, .30);
      background: linear-gradient(135deg, rgba(47, 124, 255, .15), rgba(0, 194, 255, .10));
    }

    .ws-item .dot {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, .15);
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .ws-item.active .dot {
      background: #2f7cff;
      box-shadow: 0 0 12px rgba(47, 124, 255, .60);
      transform: scale(1.1);
    }

    .ws-item.drop-highlight {
      outline: 2px solid rgba(47, 124, 255, .35);
    }

    .sb-section {
      border-top: 1px solid var(--border);
      padding-top: 10px;
      margin-top: 2px;
    }

    .sb-section .title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .sb-section .title span {
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
    }

    /* ===== Content ===== */
    .panel {
      background: rgba(255, 255, 255, .97);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, .40);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .panel:hover {
      box-shadow: 0 20px 50px rgba(2, 6, 23, .12);
    }

    .panel .hd {
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, .30);
      background: linear-gradient(180deg, rgba(2, 6, 23, .04), transparent);
    }

    .panel .hd .title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .panel .hd .title strong {
      font-size: 13px;
      letter-spacing: .2px;
    }

    .panel .hd .title span {
      font-size: 12px;
      color: var(--muted);
    }

    .panel .bd {
      padding: 14px;
    }

    .badge {
      font-size: 11px;
      color: var(--muted);
      background: rgba(2, 6, 23, .03);
      border: 1px solid var(--border);
      padding: 2px 8px;
      border-radius: 999px;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge.danger {
      color: #991b1b;
      background: rgba(239, 68, 68, .08);
      border-color: rgba(239, 68, 68, .22);
    }

    /* Board */
    .board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    @media (max-width: 1100px) {
      .board {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 650px) {
      .board {
        grid-template-columns: 1fr;
      }
    }

    .col {
      background: rgba(248, 250, 252, .95);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, .35);
      border-radius: var(--radius);
      min-height: 280px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 10px 35px rgba(2, 6, 23, .08);
      transition: all 0.3s ease;
    }

    .col:hover {
      box-shadow: 0 15px 45px rgba(2, 6, 23, .12);
    }

    .col-hd {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, .30);
      background: rgba(2, 6, 23, .04);\n    }

    .col-hd .name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 900;
      font-size: 13px;
      letter-spacing: .2px;
    }

    .dropzone {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
    }

    .card {
      background: rgba(255, 255, 255, .98);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, .40);
      border-radius: 14px;
      padding: 10px;
      box-shadow: var(--shadow-lg);
      cursor: grab;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .card:hover {
      box-shadow: 0 25px 60px rgba(2, 6, 23, .20);
      transform: translateY(-4px);
      background: rgba(255, 255, 255, 0.99);
    }

    .card.overdue {
      border-color: rgba(239, 68, 68, .40);
      box-shadow: 0 15px 40px rgba(239, 68, 68, .15);
    }

    .card:active {
      cursor: grabbing;
    }

    .card.dragging {
      opacity: 0.5;
      transform: scale(0.98);
      box-shadow: 0 30px 60px rgba(2, 6, 23, .25);
    }

    .card.drag-over {
      background: rgba(47, 124, 255, .08);
      border-color: rgba(47, 124, 255, .40);
      box-shadow: 0 0 30px rgba(47, 124, 255, .20);
    }

    .card .row1 {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .card .row1 strong {
      font-size: 13px;
      line-height: 1.2;
    }

    .card small {
      display: block;
      color: var(--muted);
      font-size: 11px;
      margin-top: 2px;
    }

    .card .desc {
      color: rgba(15, 23, 42, .92);
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      margin: 8px 0;
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(2, 6, 23, .02);
    }

    .pill.ok {
      border-color: rgba(22, 163, 74, .25);
      color: #065f46;
      background: rgba(22, 163, 74, .08);
    }

    .pill.warn {
      border-color: rgba(245, 158, 11, .25);
      color: #92400e;
      background: rgba(245, 158, 11, .08);
    }

    .pill.danger {
      border-color: rgba(239, 68, 68, .28);
      color: #991b1b;
      background: rgba(239, 68, 68, .08);
    }

    .card .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
      align-items: center;
    }

    .mini {
      padding: 7px 9px;
      border-radius: 10px;
      font-size: 12px;
    }

    /* Table */
    .hidden {
      display: none !important;
    }

    .table-wrap {
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1320px;
    }

    th,
    td {
      padding: 10px 10px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
      font-size: 12px;
    }

    th {
      position: sticky;
      top: 0;
      background: rgba(255, 255, 255, .98);
      z-index: 1;
      text-align: left;
      color: #0f172a;
      font-size: 12px;
      letter-spacing: .2px;
    }

    td {
      color: rgba(15, 23, 42, .92);
    }

    td .muted {
      color: var(--muted);
      font-size: 11px;
    }

    .all-tasks-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      padding: 10px;
      min-height: 600px;
    }

    .all-tasks-col {
      display: flex;
      flex-direction: column;
    }

    .all-col-hd {
      padding-bottom: 12px;
      margin-bottom: 16px;
      border-bottom: 2px solid rgba(47, 124, 255, .15);
    }

    .all-col-hd .name {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .all-col-hd .badge {
      background: rgba(47, 124, 255, .15);
      color: #2f7cff;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .all-col-tasks {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
    }

    .all-task-card {
      background: rgba(255, 255, 255, .98);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, .40);
      border-radius: 14px;
      padding: 12px;
      box-shadow: var(--shadow-lg);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      min-height: auto;
    }

    .all-task-card:hover {
      box-shadow: 0 25px 60px rgba(2, 6, 23, .20);
      transform: translateY(-4px);
    }

    .all-task-card .id-badge {
      display: inline-block;
      background: rgba(47, 124, 255, .15);
      color: #2f7cff;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .all-task-card .title {
      font-size: 13px;
      font-weight: 800;
      margin-bottom: 6px;
      color: var(--text);
      line-height: 1.3;
    }

    .all-task-card .workspace {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .all-task-card .status-badge {
      display: inline-block;
      background: rgba(47, 124, 255, .08);
      border: 1px solid rgba(47, 124, 255, .30);
      color: #2f7cff;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }
    }

    .table-actions {
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
      align-items: center;
    }

    /* ===== Modal HTML ===== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, .35);
      backdrop-filter: blur(4px);
      z-index: 99990;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 12px;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      width: min(920px, calc(100% - 24px));
      background: rgba(255, 255, 255, .98);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 22px 60px rgba(2, 6, 23, .18);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 48px);
      margin: auto;
      position: relative;
    }

    #taskForm {
      display: flex;
      flex-direction: column;
      min-height: 0;
      flex: 1;
      overflow: hidden;
    }

    .dlg-hd {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: linear-gradient(180deg, rgba(2, 6, 23, .03), transparent);
      flex-shrink: 0;
    }

    .dlg-bd {
      padding: 14px;
      display: grid;
      gap: 10px;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1 1 auto;
      min-height: 0;
    }

    .dlg-bd::-webkit-scrollbar {
      width: 8px;
    }

    .dlg-bd::-webkit-scrollbar-track {
      background: rgba(2, 6, 23, .02);
      border-radius: 4px;
    }

    .dlg-bd::-webkit-scrollbar-thumb {
      background: rgba(15, 23, 42, .15);
      border-radius: 4px;
    }

    .dlg-bd::-webkit-scrollbar-thumb:hover {
      background: rgba(15, 23, 42, .25);
    }

    .dlg-ft {
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
      background: rgba(2, 6, 23, .02);
      flex-shrink: 0;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    input,
    textarea,
    select {
      background: rgba(248, 250, 252, .95);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 10px;
      border-radius: 12px;
      outline: none;
      font-size: 13px;
    }

    textarea {
      min-height: 110px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 700px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .small-note {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    /* ===== Fecha t√©rmino ===== */
    .due-inline {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .due-inline input {
      flex: 1;
    }

    .cal-btn {
      width: 44px;
      padding: 10px 0;
      text-align: center;
    }

    .flatpickr-calendar {
      z-index: 99999 !important;
      box-shadow: 0 18px 45px rgba(2, 6, 23, .25);
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, .10);
      overflow: hidden;
    }

    /* ===== Checkbox Notificar ===== */
    .checkline {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(2, 6, 23, .02);
      color: rgba(15, 23, 42, .92);
      font-size: 13px;
    }

    .checkline input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    /* ===== Adjuntos ===== */
    .attach-box {
      border: 1px solid var(--border);
      background: rgba(2, 6, 23, .02);
      border-radius: 14px;
      padding: 10px;
      display: grid;
      gap: 8px;
    }

    .attach-list {
      display: grid;
      gap: 8px;
    }

    .attach-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .92);
    }

    .attach-item a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 700;
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 520px;
      display: inline-block;
    }

    .attach-item small {
      color: var(--muted);
      font-size: 11px;
    }

    /* ===== Overdue modal ===== */
    .overdue-table-wrap {
      overflow: auto;
    }

    .overdue-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 920px;
    }

    .overdue-table th,
    .overdue-table td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      vertical-align: top;
    }

    .row-overdue {
      background: rgba(239, 68, 68, .05);
    }

    /* ===== Drag & Drop adjuntos sobre tarea ===== */
    .card.drag-over {
      outline: 2px dashed rgba(47, 124, 255, .7);
      background: rgba(47, 124, 255, .06);
    }

    .attach-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }

    /* ===== NUEVO: l√≠nea de adjuntos en tarjeta ===== */
    .fileline {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filepick {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 9px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .92);
      box-shadow: 0 6px 18px rgba(2, 6, 23, .05);
      color: var(--text);
      user-select: none;
    }

    .filepick:active {
      transform: translateY(1px);
    }

    .filepick:hover {
      filter: brightness(1.02);
    }

    /* ===== Estilos para el administrador de espacios ===== */
    .ws-status-active {
      color: #065f46;
      background: rgba(22, 163, 74, .08);
      border-color: rgba(22, 163, 74, .25);
    }

    .ws-status-hidden {
      color: #92400e;
      background: rgba(245, 158, 11, .08);
      border-color: rgba(245, 158, 11, .25);
    }

    .ws-task-count {
      font-weight: bold;
      font-size: 12px;
    }

    .ws-task-count.empty {
      color: var(--muted);
    }

    .ws-task-count.has-tasks {
      color: #0f172a;
    }

    .ws-actions {
      display: flex;
      gap: 6px;
      flex-wrap: nowrap;
      justify-content: center;
    }

    .editable-ws-name {
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .editable-ws-name:hover {
      background: rgba(47, 124, 255, .05);
      border-color: rgba(47, 124, 255, .15);
    }

    .editable-ws-name.editing {
      background: white;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(47, 124, 255, .1);
    }

    /* ===== Botones espec√≠ficos para admin espacios ===== */
    .ws-btn-show {
      background: rgba(22, 163, 74, .08);
      border-color: rgba(22, 163, 74, .25);
      color: #065f46;
    }

    .ws-btn-hide {
      background: rgba(245, 158, 11, .08);
      border-color: rgba(245, 158, 11, .25);
      color: #92400e;
    }

    .ws-btn-rename {
      background: rgba(47, 124, 255, .08);
      border-color: rgba(47, 124, 255, .25);
      color: #1e40af;
    }

    .ws-btn-delete {
      background: rgba(239, 68, 68, .08);
      border-color: rgba(239, 68, 68, .25);
      color: #991b1b;
    }

    /* ===== NUEVO: Estilos para campos personalizados ===== */
    .custom-fields-section {
      border: 1px solid var(--border);
      background: rgba(2, 6, 23, .02);
      border-radius: 14px;
      padding: 10px;
      display: grid;
      gap: 10px;
    }

    .custom-fields-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .custom-field-item {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items: end;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .92);
    }

    @media (max-width: 700px) {
      .custom-field-item {
        grid-template-columns: 1fr;
      }
    }

    .custom-field-value {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(248, 250, 252, .95);
      font-size: 13px;
      min-height: 42px;
      display: flex;
      align-items: center;
    }

    .priority-badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .priority-high {
      background: rgba(239, 68, 68, .12);
      border: 1px solid rgba(239, 68, 68, .25);
      color: #991b1b;
    }

    .priority-medium {
      background: rgba(245, 158, 11, .12);
      border: 1px solid rgba(245, 158, 11, .25);
      color: #92400e;
    }

    .priority-low {
      background: rgba(22, 163, 74, .12);
      border: 1px solid rgba(22, 163, 74, .25);
      color: #065f46;
    }

    .custom-field-pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(47, 124, 255, .08);
      border: 1px solid rgba(47, 124, 255, .15);
      color: #1e40af;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 6px;
    }

    .field-type-icon {
      font-size: 12px;
      opacity: 0.8;
    }

    /* ===== Modal para administrar campos personalizados ===== */
    .field-config-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items: end;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, .92);
    }

    @media (max-width: 700px) {
      .field-config-row {
        grid-template-columns: 1fr;
      }
    }

    .field-config-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .empty-fields-message {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-style: italic;
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="txt">
          <strong>Tablero Tareas</strong>
          <span>Workspaces ¬∑ Victor Espinoza Concha</span>
        </div>
      </div>

      <div class="controls">
        <div class="segmented" title="Cambiar vista">
          <button id="btnViewBoard" class="active" type="button">Tablero</button>
          <button id="btnViewTable" type="button">Tabla</button>
          <button id="btnViewAll" type="button">Todas</button>
        </div>

        <div class="search" title="Buscar por ID, nombre, responsable, descripci√≥n o campos personalizados">
          <span style="color:var(--muted); font-weight:900;">‚åï</span>
          <input id="search" type="text" placeholder="Buscar tarea o campos personalizados‚Ä¶" />
          <span class="hint">Ctrl + K</span>
        </div>

        <button id="btnOverdue" class="secondary" type="button">Vencidas <span id="overdueCount" class="badge danger"
            style="margin-left:6px;">0</span></button>

        <button id="btnCreate" class="primary" type="button">+ Crear tarea</button>
        <button id="btnExportXLSX" class="secondary" type="button">Exportar Excel</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sb-hd">
        <strong style="font-size: 18px; letter-spacing: 0.3px;">Espacios</strong>
      </div>
      <div class="sb-bd">
        <div class="ws-list" id="wsList"></div>

        <div class="sb-section">
          <div class="title">
            <span>Estad√≠sticas</span>
            <span class="badge" id="sbCounts">‚Äî</span>
          </div>
          <button id="btnConfig" class="secondary mini" type="button" title="Configuraci√≥n"
            style="padding: 6px 10px; font-size: 13px; width: 100%; margin-top: 8px; justify-content: flex-start;">‚öôÔ∏è Configuraci√≥n</button>
        </div>

        <div class="small-note" style="opacity:.85;">
        </div>
      </div>
    </aside>

    <!-- Content -->
    <section class="panel">
      <div class="hd">
        <div class="title">
          <strong id="viewTitle">Vista: Tablero</strong>
          <span id="stats" class="badge">Cargando‚Ä¶</span>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <span class="badge" id="wsBadge">Espacio: ‚Äî</span>
          <label style="min-width:240px;">
            Ordenar por
            <select id="sortBy">
              <option value="id_desc">ID (desc)</option>
              <option value="id_asc">ID (asc)</option>
              <option value="created_desc">Creaci√≥n (desc)</option>
              <option value="created_asc">Creaci√≥n (asc)</option>
              <option value="updated_desc">Modificaci√≥n (desc)</option>
              <option value="updated_asc">Modificaci√≥n (asc)</option>
              <option value="due_asc">T√©rmino (asc)</option>
              <option value="due_desc">T√©rmino (desc)</option>
              <option value="status_asc">Estado (A‚ÜíZ)</option>
              <option value="resp_asc">Responsable (A‚ÜíZ)</option>
            </select>
          </label>
        </div>
      </div>

      <div class="bd">
        <div id="viewBoard">
          <div class="board" id="board"></div>
        </div>

        <div id="viewTable" class="hidden">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Espacio de trabajo</th>
                  <th>Nombre</th>
                  <th>Descripci√≥n</th>
                  <th>Responsable</th>
                  <th>Estado</th>
                  <th>Creaci√≥n</th>
                  <th>Revisi√≥n/Modificaci√≥n</th>
                  <th>Fecha t√©rmino</th>
                  <th>Fecha cierre</th>
                  <th>Adjuntos</th>
                  <th>Campos Personalizados</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
          <div class="small-note" style="margin-top:10px; opacity:.9;">
            Tip: doble click sobre una fila para editar la tarea.
          </div>
        </div>

        <div id="viewAll" class="hidden">
          <div class="all-tasks-grid" id="allTasksGrid"></div>
          <div class="small-note" style="margin-top:10px; opacity:.9;">
            Todas las tareas de todos los espacios
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- ===== MODAL TAREA ===== -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
      <div class="dlg-hd">
        <div>
          <strong id="dlgTitle">Crear tarea</strong>
          <div class="small-note" id="dlgSub"></div>
        </div>
        <button class="secondary mini" id="dlgCloseX" type="button">Cerrar</button>
      </div>

      <form id="taskForm">
        <div class="dlg-bd">
          <div class="form-row">
            <label>
              Nombre de la tarea *
              <input id="f_name" type="text" required maxlength="120" />
            </label>

            <label>
              Responsable (correo)
              <select id="f_resp"></select>
            </label>
          </div>

          <div class="form-row">
            <label>
              Estado
              <select id="f_status">
                <option value="Pendiente">Pendiente</option>
                <option value="En Progreso">En Progreso</option>
                <option value="En Revisi√≥n">En Revisi√≥n</option>
                <option value="Cerrada">Cerrada</option>
              </select>
            </label>

            <label>
              Espacio de trabajo
              <select id="f_wsSelect"></select>
            </label>
          </div>

          <div class="form-row">
            <label>
              Fecha t√©rmino (DD-MM-YYYY HH:mm)
              <div class="due-inline">
                <input id="f_dueDateDisplay" type="text" readonly placeholder="DD-MM-YYYY HH:mm" />
                <button id="btnDueOpen" class="secondary cal-btn" type="button" title="Abrir calendario">üìÖ</button>
              </div>
              <input id="f_dueDate" type="hidden" />
            </label>

            <label>
              Fecha cierre (auto al cerrar)
              <input id="f_closedAt" type="text" disabled />
            </label>
          </div>

          <!-- ===== CAMPOS PERSONALIZADOS en Modal Tarea ===== -->
          <div class="custom-fields-section">
            <div class="custom-fields-header">
              <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <strong style="font-size:13px;">Campos Personalizados</strong>
                <span class="badge" id="customFieldsCount">0</span>
              </div>
            </div>

            <div class="small-note" id="noCustomFieldsMsg">No hay campos personalizados configurados. Ve a "Campos
              Personalizados" en la barra lateral para crear algunos.</div>

            <div id="customFieldsContainer"></div>
          </div>

          <div class="form-row">
            <div class="checkline">
              <input id="f_notifyOnSave" type="checkbox" />
              <span>Notificar al guardar (abre Outlook)</span>
            </div>
            <div class="small-note" style="opacity:.9;">
              Abre un correo listo para enviar usando el cliente predeterminado (MAILTO).
            </div>
          </div>

          <label>
            Descripci√≥n de la tarea
            <textarea id="f_desc" placeholder="Detalles, contexto, links‚Ä¶"></textarea>
          </label>

          <!-- ===== Adjuntos ===== -->
          <div class="attach-box">
            <div class="attach-actions">
              <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <strong style="font-size:13px;">Adjuntos</strong>
                <span class="badge" id="attachCount">0</span>
              </div>
            </div>

            <div class="small-note">Puedes adjuntar varios archivos. Se guardan en Supabase Storage (bucket:
              task-attachments). Tambi√©n puedes soltar archivos sobre una tarea en el tablero.</div>

            <div class="form-row">
              <label style="grid-column: 1 / -1;">
                Agregar archivos (m√∫ltiples)
                <input id="f_files" type="file" multiple />
              </label>
            </div>

            <div class="small-note" id="filePendingInfo"></div>

            <div class="attach-list" id="attachList"></div>
          </div>

          <div class="small-note" id="f_meta"></div>
        </div>

        <div class="dlg-ft">
          <button type="button" id="btnDeleteTask" class="secondary danger-btn"
            style="margin-right:auto;">Eliminar</button>
          <button type="button" class="secondary" id="btnCancelTask">Cancelar</button>
          <button type="submit" class="primary" id="btnSaveTask">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== MODAL RESPONSABLES ===== -->
  <div id="respBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="respTitle">
      <div class="dlg-hd">
        <div>
          <strong id="respTitle">Responsables</strong>
          <div class="small-note">Crea, edita o desactiva responsables.</div>
        </div>
        <button class="secondary mini" id="btnCloseResp" type="button">Cerrar</button>
      </div>

      <div class="dlg-bd" style="display:grid; gap:12px;">
        <div class="form-row">
          <label>
            Nombre
            <input id="r_name" type="text" maxlength="120" placeholder="Nombre y apellido" />
          </label>
          <label>
            Email
            <input id="r_email" type="email" placeholder="correo@dominio.cl" />
          </label>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="btnAddResp" class="primary" type="button">Guardar responsable</button>
          <button id="btnClearResp" class="secondary" type="button">Limpiar</button>
        </div>

        <div style="overflow:auto;">
          <table style="width:100%; border-collapse: collapse; min-width: 640px;">
            <thead>
              <tr>
                <th style="padding:10px; border-bottom:1px solid var(--border);">Nombre</th>
                <th style="padding:10px; border-bottom:1px solid var(--border);">Email</th>
                <th style="padding:10px; border-bottom:1px solid var(--border);">Estado</th>
                <th style="padding:10px; border-bottom:1px solid var(--border);">Acciones</th>
              </tr>
            </thead>
            <tbody id="respTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="dlg-ft">
        <button class="secondary" type="button" id="btnRespDone">Listo</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL VENCIDAS ===== -->
  <div id="overdueBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="overdueTitle">
      <div class="dlg-hd">
        <div>
          <strong id="overdueTitle">Tareas vencidas</strong>
          <div class="small-note">Fecha actual mayor a Fecha t√©rmino (solo no cerradas).</div>
        </div>
        <button class="secondary mini" id="btnCloseOverdue" type="button">Cerrar</button>
      </div>

      <div class="dlg-bd">
        <div class="badge danger" id="overdueSummary">‚Äî</div>

        <div class="overdue-table-wrap">
          <table class="overdue-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Espacio</th>
                <th>Nombre</th>
                <th>Responsable</th>
                <th>Fecha t√©rmino</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="overdueTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="dlg-ft">
        <button class="secondary" type="button" id="btnOverdueGoCurrent">Ver mi espacio actual</button>
        <button class="primary" type="button" id="btnOverdueRefresh">Actualizar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL ADMINISTRAR ESPACIOS ===== -->
  <div id="adminWSBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="adminWSTitle">
      <div class="dlg-hd">
        <div>
          <strong id="adminWSTitle">Administrar Espacios de Trabajo</strong>
          <div class="small-note">Mostrar, ocultar, renombrar o eliminar espacios. Advertencia si tienen tareas activas.
          </div>
        </div>
        <button class="secondary mini" id="btnCloseAdminWS" type="button">Cerrar</button>
      </div>

      <div class="dlg-bd" style="display:grid; gap:12px;">
        <div class="attach-box">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <strong style="font-size:13px;">Lista de Espacios</strong>
            <span class="badge" id="wsAdminCount">Total: 0</span>
          </div>

          <div class="small-note" style="margin-top:4px;">
            <strong>Instrucciones:</strong>
            <ul style="margin:6px 0 0 0; padding-left:18px;">
              <li><strong>Ocultar:</strong> El espacio no aparecer√° en el sidebar pero sus tareas se mantienen</li>
              <li><strong>Mostrar:</strong> Reactiva un espacio oculto</li>
              <li><strong>Cambiar nombre:</strong> Doble clic sobre el nombre o usa el bot√≥n Editar</li>
              <li><strong>Eliminar:</strong> Solo disponible si el espacio est√° vac√≠o (sin tareas)</li>
            </ul>
          </div>
        </div>

        <div style="overflow:auto; max-height:400px;">
          <table style="width:100%; border-collapse: collapse; min-width: 800px;">
            <thead>
              <tr>
                <th style="padding:10px; border-bottom:1px solid var(--border);">ID</th>
                <th style="padding:10px; border-bottom:1px solid var(--border);">Nombre</th>
                <th style="padding:10px; border-bottom:1px solid var(--border);">Estado</th>
                <th style="padding:10px; border-bottom:1px solid var(--border);">Tareas Activas</th>
                <th style="padding:10px; border-bottom:1px solid var(--border); text-align:center;">Acciones</th>
              </tr>
            </thead>
            <tbody id="adminWSTbody"></tbody>
          </table>
        </div>

        <div class="attach-box">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <strong style="font-size:13px;">Crear Nuevo Espacio</strong>
          </div>

          <div class="form-row">
            <label style="grid-column: 1 / -1;">
              Nombre del espacio
              <input id="newWSName" type="text" placeholder="Ej: Marketing Q2" maxlength="100" />
            </label>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="btnCreateNewWS" class="primary" type="button">Crear Espacio</button>
            <button id="btnClearNewWS" class="secondary" type="button">Limpiar</button>
          </div>
        </div>
      </div>

      <div class="dlg-ft">
        <div style="display:flex; align-items:center; gap:8px; margin-right:auto;">
          <span class="badge ok" id="activeWSCount">Activos: 0</span>
          <span class="badge warn" id="hiddenWSCount">Ocultos: 0</span>
          <span class="badge" id="tasksInWSCount">Tareas: 0</span>
        </div>
        <button class="secondary" type="button" id="btnAdminWSDone">Listo</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL CONFIRMAR ELIMINAR ESPACIO CON TAREAS ===== -->
  <div id="confirmDeleteWSBackdrop" class="modal-backdrop">
    <div class="modal" style="max-width: 600px;" role="dialog" aria-modal="true" aria-labelledby="confirmDeleteWSTitle">
      <div class="dlg-hd">
        <div>
          <strong id="confirmDeleteWSTitle">‚ö†Ô∏è Confirmar Eliminaci√≥n</strong>
          <div class="small-note">El espacio contiene tareas activas</div>
        </div>
      </div>

      <div class="dlg-bd">
        <div
          style="display:flex; align-items:center; gap:12px; margin-bottom:16px; padding:12px; background:rgba(239,68,68,.06); border-radius:12px; border:1px solid rgba(239,68,68,.2);">
          <div style="font-size:32px; color:#ef4444;">‚ö†Ô∏è</div>
          <div style="flex:1;">
            <strong style="color:#991b1b; display:block; margin-bottom:4px;">No se puede eliminar el espacio "<span
                id="wsToDeleteName"></span>"</strong>
            <span style="font-size:12px; color:#991b1b;">Contiene <span id="wsToDeleteTaskCount"
                style="font-weight:bold;">0</span> tarea(s) activa(s).</span>
          </div>
        </div>

        <div class="attach-box">
          <strong style="font-size:13px; display:block; margin-bottom:8px;">Opciones disponibles:</strong>
          <div style="display:grid; gap:8px;">
            <label
              style="display:flex; align-items:center; gap:10px; padding:10px; border-radius:10px; border:1px solid var(--border); cursor:pointer;"
              for="optionMoveTasks">
              <input type="radio" id="optionMoveTasks" name="deleteOption" value="move" checked />
              <div style="flex:1;">
                <div style="font-weight:bold; font-size:13px;">Mover tareas a otro espacio</div>
                <div class="small-note">Selecciona un espacio destino para mover todas las tareas</div>
              </div>
            </label>

            <label
              style="display:flex; align-items:center; gap:10px; padding:10px; border-radius:10px; border:1px solid var(--border); cursor:pointer;"
              for="optionHideWS">
              <input type="radio" id="optionHideWS" name="deleteOption" value="hide" />
              <div style="flex:1;">
                <div style="font-weight:bold; font-size:13px;">Ocultar espacio</div>
                <div class="small-note">El espacio dejar√° de mostrarse pero las tareas se mantienen</div>
              </div>
            </label>

            <label
              style="display:flex; align-items:center; gap:10px; padding:10px; border-radius:10px; border:1px solid var(--border); cursor:pointer;"
              for="optionDeleteAll">
              <input type="radio" id="optionDeleteAll" name="deleteOption" value="deleteAll" />
              <div style="flex:1;">
                <div style="font-weight:bold; font-size:13px; color:#991b1b;">Eliminar espacio y todas sus tareas</div>
                <div class="small-note" style="color:#991b1b;">‚ö†Ô∏è Eliminar√° permanentemente <span
                    id="deleteAllTaskCount">0</span> tarea(s). Esta acci√≥n no se puede deshacer.</div>
              </div>
            </label>
          </div>

          <div id="moveTasksSection" style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
            <label>
              Espacio destino para mover las tareas
              <select id="moveToWSSelect" style="margin-top:6px;"></select>
            </label>
          </div>
        </div>
      </div>

      <div class="dlg-ft">
        <button type="button" class="secondary" id="btnCancelDeleteWS">Cancelar</button>
        <button type="button" class="secondary danger-btn" id="btnConfirmDeleteWS">Proceder</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL CONFIGURACI√ìN ===== -->
  <div id="configBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="configTitle" style="max-width: 500px;">
      <div class="dlg-hd">
        <div>
          <strong id="configTitle">Configuraci√≥n</strong>
          <div class="small-note">Gestiona responsables, espacios y campos personalizados</div>
        </div>
        <button class="secondary mini" id="btnCloseConfig" type="button">Cerrar</button>
      </div>

      <div class="dlg-bd" style="display:grid; gap:12px;">
        <div class="attach-box">
          <div style="display:flex; flex-direction:column; gap:12px;">
            <button id="btnConfigManageResp" class="secondary" type="button"
              style="width:100%; padding:12px; text-align:left; display:flex; align-items:center; gap:10px;">
              <span style="font-size:18px;">üë•</span>
              <div style="flex:1;">
                <div style="font-weight:700; font-size:13px;">Responsables</div>
                <div class="small-note">Gestiona los responsables de las tareas</div>
              </div>
            </button>

            <button id="btnConfigManageWS" class="secondary" type="button"
              style="width:100%; padding:12px; text-align:left; display:flex; align-items:center; gap:10px;">
              <span style="font-size:18px;">üìÅ</span>
              <div style="flex:1;">
                <div style="font-weight:700; font-size:13px;">Administrar Espacios</div>
                <div class="small-note">Crea, edita o elimina espacios de trabajo</div>
              </div>
            </button>

            <button id="btnConfigManageFields" class="secondary" type="button"
              style="width:100%; padding:12px; text-align:left; display:flex; align-items:center; gap:10px;">
              <span style="font-size:18px;">‚öôÔ∏è</span>
              <div style="flex:1;">
                <div style="font-weight:700; font-size:13px;">Campos Personalizados</div>
                <div class="small-note">Crea campos adicionales para las tareas</div>
              </div>
            </button>
          </div>
        </div>
      </div>

      <div class="dlg-ft">
        <button type="button" class="secondary" id="btnConfigDone">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL ADMINISTRAR CAMPOS PERSONALIZADOS ===== -->
  <div id="manageFieldsBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="manageFieldsTitle">
      <div class="dlg-hd">
        <div>
          <strong id="manageFieldsTitle">Campos Personalizados</strong>
          <div class="small-note">Crea y gestiona campos personalizados para las tareas. Se aplican a todas las tareas
            del sistema.</div>
        </div>
        <button class="secondary mini" id="btnCloseManageFields" type="button">Cerrar</button>
      </div>

      <div class="dlg-bd" style="display:grid; gap:12px;">
        <div class="attach-box">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <strong style="font-size:13px;">Nuevo Campo Personalizado</strong>
          </div>

          <div class="form-row">
            <label>
              Nombre del campo
              <input id="newFieldName" type="text" placeholder="Ej: Presupuesto, Prioridad, Sprint" maxlength="50" />
            </label>
            <label>
              Tipo de dato
              <select id="newFieldType">
                <option value="text">Texto</option>
                <option value="number">N√∫mero</option>
                <option value="date">Fecha</option>
                <option value="priority">Prioridad (Alta, Media, Baja)</option>
              </select>
            </label>
          </div>

          <div class="small-note">
            <strong>Tipos disponibles:</strong>
            <ul style="margin:6px 0 0 0; padding-left:18px;">
              <li><strong>Texto:</strong> Campo de texto libre</li>
              <li><strong>N√∫mero:</strong> Valor num√©rico (entero o decimal)</li>
              <li><strong>Fecha:</strong> Fecha con selector de calendario</li>
              <li><strong>Prioridad:</strong> Selecci√≥n entre Alta, Media o Baja (con colores)</li>
            </ul>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="btnAddCustomField" class="primary" type="button">Agregar Campo</button>
            <button id="btnClearNewField" class="secondary" type="button">Limpiar</button>
          </div>
        </div>

        <div class="attach-box">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <strong style="font-size:13px;">Campos Configurados</strong>
            <span class="badge" id="fieldsCount">Total: 0</span>
          </div>

          <div class="small-note" style="margin-top:4px;">
            Los campos se mostrar√°n en todas las tareas. Puedes reordenarlos arrastrando (pr√≥ximamente).
          </div>

          <div id="fieldsConfigContainer">
            <div class="empty-fields-message" id="emptyFieldsMessage">
              No hay campos personalizados configurados. Agrega tu primer campo arriba.
            </div>
          </div>
        </div>
      </div>

      <div class="dlg-ft">
        <button class="secondary" type="button" id="btnManageFieldsDone">Listo</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const SUPABASE_URL = "https://pjfpeudhtndmixyxwwdf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBqZnBldWRodG5kbWl4eXh3d2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTk5NTUsImV4cCI6MjA4Mzg5NTk1NX0.PSSrEWt-fbaF_QLDTDTEza4w2HQaOd3zZCCGYpLFtSA";
    let _supabase;

    (() => {
      // Intentar inicializar supabase
      try {
        if (typeof supabase !== 'undefined') {
          _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } else {
          console.error("Supabase SDK no cargado.");
        }
      } catch (e) {
        console.error("Error inicializando Supabase:", e);
      }
      const STATUSES = ["Pendiente", "En Progreso", "En Revisi√≥n", "Cerrada"];
      const TZ_CL = "America/Santiago";
      const PRIORITY_OPTIONS = ["Alta", "Media", "Baja"];
      const FIELD_TYPES = [
        { value: "text", label: "Texto", icon: "üìù" },
        { value: "number", label: "N√∫mero", icon: "üî¢" },
        { value: "date", label: "Fecha", icon: "üìÖ" },
        { value: "priority", label: "Prioridad", icon: "‚ö°" }
      ];

      let state = {
        workspaces: [],
        responsables: [],
        tasks: [],
        currentWorkspaceId: 0,
        customFields: [], // Nuevo: almacena los campos personalizados
        changelog: [] // Nuevo: historial de cambios de tareas
      };

      // Header controls
      const btnViewBoard = document.getElementById("btnViewBoard");
      const btnViewTable = document.getElementById("btnViewTable");
      const viewBoard = document.getElementById("viewBoard");
      const viewTable = document.getElementById("viewTable");
      const viewTitle = document.getElementById("viewTitle");

      const searchEl = document.getElementById("search");
      const sortByEl = document.getElementById("sortBy");
      const statsEl = document.getElementById("stats");
      const wsBadge = document.getElementById("wsBadge");
      const sbCounts = document.getElementById("sbCounts");

      const btnCreate = document.getElementById("btnCreate");
      const btnExportXLSX = document.getElementById("btnExportXLSX");

      // Overdue UI
      const btnOverdue = document.getElementById("btnOverdue");
      const overdueCount = document.getElementById("overdueCount");

      // Sidebar
      const wsList = document.getElementById("wsList");

      // Board/Table
      const boardEl = document.getElementById("board");
      const tbody = document.getElementById("tbody");

      // Modal Task
      const modalBackdrop = document.getElementById("modalBackdrop");
      const dlgCloseX = document.getElementById("dlgCloseX");
      const taskForm = document.getElementById("taskForm");
      const dlgTitle = document.getElementById("dlgTitle");
      const dlgSub = document.getElementById("dlgSub");

      const f_name = document.getElementById("f_name");
      const f_resp = document.getElementById("f_resp");
      const f_desc = document.getElementById("f_desc");
      const f_status = document.getElementById("f_status");
      const f_wsSelect = document.getElementById("f_wsSelect");

      const f_dueDateDisplay = document.getElementById("f_dueDateDisplay");
      const f_dueDate = document.getElementById("f_dueDate");
      const btnDueOpen = document.getElementById("btnDueOpen");

      const f_closedAt = document.getElementById("f_closedAt");
      const f_meta = document.getElementById("f_meta");

      const btnCancelTask = document.getElementById("btnCancelTask");
      const btnDeleteTask = document.getElementById("btnDeleteTask");

      const f_notifyOnSave = document.getElementById("f_notifyOnSave");

      // Adjuntos
      const f_files = document.getElementById("f_files");
      const attachList = document.getElementById("attachList");
      const attachCount = document.getElementById("attachCount");
      const filePendingInfo = document.getElementById("filePendingInfo");

      // Campos personalizados en modal tarea
      const customFieldsCount = document.getElementById("customFieldsCount");
      const noCustomFieldsMsg = document.getElementById("noCustomFieldsMsg");
      const customFieldsContainer = document.getElementById("customFieldsContainer");

      let pendingFiles = [];
      let fpDue = null;
      let fieldDatePickers = {}; // Para manejar los datepickers de campos personalizados

      let dialogMode = "create";
      let editingId = null;

      // Anti doble submit + idempotencia creaci√≥n
      let savingTask = false;
      let createRequestId = null;

      // Modal Responsables
      const respBackdrop = document.getElementById("respBackdrop");
      const btnCloseResp = document.getElementById("btnCloseResp");
      const btnRespDone = document.getElementById("btnRespDone");
      const r_name = document.getElementById("r_name");
      const r_email = document.getElementById("r_email");
      const btnAddResp = document.getElementById("btnAddResp");
      const btnClearResp = document.getElementById("btnClearResp");
      const respTbody = document.getElementById("respTbody");

      // Modal Vencidas
      const overdueBackdrop = document.getElementById("overdueBackdrop");
      const btnCloseOverdue = document.getElementById("btnCloseOverdue");
      const overdueTbody = document.getElementById("overdueTbody");
      const overdueSummary = document.getElementById("overdueSummary");
      const btnOverdueRefresh = document.getElementById("btnOverdueRefresh");
      const btnOverdueGoCurrent = document.getElementById("btnOverdueGoCurrent");

      // Modal Administrar Espacios
      const adminWSBackdrop = document.getElementById("adminWSBackdrop");
      const btnCloseAdminWS = document.getElementById("btnCloseAdminWS");
      const btnAdminWSDone = document.getElementById("btnAdminWSDone");
      const adminWSTbody = document.getElementById("adminWSTbody");
      const wsAdminCount = document.getElementById("wsAdminCount");
      const activeWSCount = document.getElementById("activeWSCount");
      const hiddenWSCount = document.getElementById("hiddenWSCount");
      const tasksInWSCount = document.getElementById("tasksInWSCount");

      const newWSName = document.getElementById("newWSName");
      const btnCreateNewWS = document.getElementById("btnCreateNewWS");
      const btnClearNewWS = document.getElementById("btnClearNewWS");

      // Modal confirmar eliminar espacio
      const confirmDeleteWSBackdrop = document.getElementById("confirmDeleteWSBackdrop");
      const confirmDeleteWSTitle = document.getElementById("confirmDeleteWSTitle");
      const wsToDeleteName = document.getElementById("wsToDeleteName");
      const wsToDeleteTaskCount = document.getElementById("wsToDeleteTaskCount");
      const deleteAllTaskCount = document.getElementById("deleteAllTaskCount");
      const moveToWSSelect = document.getElementById("moveToWSSelect");
      const moveTasksSection = document.getElementById("moveTasksSection");
      const btnCancelDeleteWS = document.getElementById("btnCancelDeleteWS");
      const btnConfirmDeleteWS = document.getElementById("btnConfirmDeleteWS");

      let wsToDelete = null;
      let wsToDeleteId = null;
      let editingWSName = null;

      // ===== Modal Configuraci√≥n =====
      const configBackdrop = document.getElementById("configBackdrop");
      const btnConfig = document.getElementById("btnConfig");
      const btnCloseConfig = document.getElementById("btnCloseConfig");
      const btnConfigDone = document.getElementById("btnConfigDone");
      const btnConfigManageResp = document.getElementById("btnConfigManageResp");
      const btnConfigManageWS = document.getElementById("btnConfigManageWS");
      const btnConfigManageFields = document.getElementById("btnConfigManageFields");

      // ===== Modal Administrar Campos Personalizados =====
      const manageFieldsBackdrop = document.getElementById("manageFieldsBackdrop");
      const btnCloseManageFields = document.getElementById("btnCloseManageFields");
      const btnManageFieldsDone = document.getElementById("btnManageFieldsDone");
      const newFieldName = document.getElementById("newFieldName");
      const newFieldType = document.getElementById("newFieldType");
      const btnAddCustomField = document.getElementById("btnAddCustomField");
      const btnClearNewField = document.getElementById("btnClearNewField");
      const fieldsCount = document.getElementById("fieldsCount");
      const emptyFieldsMessage = document.getElementById("emptyFieldsMessage");
      const fieldsConfigContainer = document.getElementById("fieldsConfigContainer");



      async function bootstrap() {
        console.log("Iniciando bootstrap...");
        statsEl.textContent = "Conectando...";
        try {
          const data = await gs("getBootstrap");
          console.log("Datos recibidos de Supabase:", data);
          if (!data || !data.ok) throw new Error(data?.error || "Respuesta de Supabase no v√°lida");

          state.workspaces = data.workspaces || [];
          state.responsables = data.responsables || [];
          state.tasks = (data.tareas || []).map(t => ({ ...t, adjuntos: Array.isArray(t.adjuntos) ? t.adjuntos : [] }));
          state.customFields = data.customFields || [];

          console.log(`Cargados: ${state.workspaces.length} espacios, ${state.tasks.length} tareas.`);

          if (state.workspaces.length === 0) {
            console.log("No hay espacios, creando 'General'...");
            const created = await gs("upsertWorkspace", { nombre: "General", activo: true });
            if (created.ok) state.workspaces = [created.data];
          }

          const firstActive = state.workspaces.find(w => w.activo) || state.workspaces[0];
          state.currentWorkspaceId = firstActive ? firstActive.id : 0;

          populateResponsibleSelect();
          populateWorkspaceSelect(state.currentWorkspaceId);
          renderSidebar();
          renderAll();
          statsEl.textContent = "Conectado";

          // SUSCRIPCI√ìN EN TIEMPO REAL (Solo una vez)
          _supabase
            .channel('public:tareas')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'tareas' }, async (payload) => {
              console.log('Cambio detectado en tiempo real:', payload);
              const res = await supabaseService.getBootstrap();
              if (res.ok) {
                state.workspaces = res.workspaces;
                state.responsables = res.responsables;
                state.tasks = res.tareas;
                state.customFields = res.customFields;
                renderAll();
                renderSidebar();
              }
            })
            .subscribe();

        } catch (err) {
          console.error("Error cr√≠tico en bootstrap:", err);
          statsEl.textContent = "Error de conexi√≥n";
          const errorMsg = err.message || JSON.stringify(err);
          if (errorMsg.includes("fetch") || errorMsg.includes("NetworkError")) {
            alert("‚ö†Ô∏è Error de conexi√≥n (CORS).\n\nEs probable que el navegador est√© bloqueando la conexi√≥n por abrir el archivo localmente (file://).\n\nSOLUCI√ìN: Usa un servidor local (como Live Server de VS Code o Python) para evitar restricciones de seguridad.");
          } else {
            alert("No se pudo cargar desde Supabase.\n\nDetalle: " + errorMsg);
          }
        }
      }

      function wireUI() {
        btnViewBoard.addEventListener("click", () => setView("board"));
        btnViewTable.addEventListener("click", () => setView("table"));
        btnViewAll.addEventListener("click", () => setView("all"));

        searchEl.addEventListener("input", renderAll);
        sortByEl.addEventListener("change", renderAll);

        btnCreate.addEventListener("click", openCreate);
        btnExportXLSX.addEventListener("click", exportXLSX);

        btnOverdue.addEventListener("click", openOverdueModal);
        btnCloseOverdue.addEventListener("click", closeOverdueModal);
        btnOverdueRefresh.addEventListener("click", () => { renderOverdueModal(); renderOverdueBadge(); });
        btnOverdueGoCurrent.addEventListener("click", () => { closeOverdueModal(); setView("board"); renderAll(); });

        // ===== Listeners para modal de configuraci√≥n =====
        btnConfig.addEventListener("click", openConfigModal);
        btnCloseConfig.addEventListener("click", closeConfigModal);
        btnConfigDone.addEventListener("click", closeConfigModal);
        configBackdrop.addEventListener("click", (e) => {
          if (e.target === configBackdrop) closeConfigModal();
        });

        // Botones dentro del modal de configuraci√≥n
        btnConfigManageResp.addEventListener("click", () => {
          closeConfigModal();
          openRespModal();
        });
        btnConfigManageWS.addEventListener("click", () => {
          closeConfigModal();
          openWSAdmin();
        });
        btnConfigManageFields.addEventListener("click", () => {
          closeConfigModal();
          openManageFieldsModal();
        });

        dlgCloseX.addEventListener("click", closeTaskModal);
        btnCancelTask.addEventListener("click", closeTaskModal);
        modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeTaskModal(); });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && modalBackdrop.classList.contains("show"))
            closeTaskModal();
        });

        btnDeleteTask.addEventListener("click", async () => {
          if (dialogMode !== "edit" || editingId == null) return;
          if (!confirm(`¬øEliminar tarea #${editingId}?`)) return;

          try {
            const res = await gs("deleteTarea", editingId);
            if (!res || !res.ok) { alert("No se pudo eliminar."); return; }
            state.tasks = state.tasks.filter(t => t.id !== editingId);
            closeTaskModal();
            renderAll();
          } catch (err) {
            alert("Error eliminando: " + (err && err.message ? err.message : err));
          }
        });

        // Adjuntos (pendientes) en MODAL
        f_files.addEventListener("change", () => {
          pendingFiles = Array.from(f_files.files || []);
          renderPendingFilesInfo();
        });

        // ===== Guardar (anti doble click + idempotencia creaci√≥n) =====
        taskForm.addEventListener("submit", async (ev) => {
          ev.preventDefault();

          if (savingTask) return;
          savingTask = true;

          const btn = document.getElementById("btnSaveTask");
          const prevTxt = btn.textContent;
          btn.disabled = true;
          btn.textContent = "Guardando...";

          try {
            const nowIso = new Date().toISOString();
            const wsId = Number(f_wsSelect.value) || state.currentWorkspaceId;
            if (!wsId) {
              alert("Debes seleccionar un espacio de trabajo.");
              return;
            }

            const email = (f_resp.value || "").trim();
            const nombreResp = responsibleLabelByEmail(email);
            const dueStr = (f_dueDate.value || "").trim();

            // Recolectar valores de campos personalizados
            const customFieldsValues = {};
            if (state.customFields && state.customFields.length > 0) {
              state.customFields.forEach(field => {
                const input = document.getElementById(`custom_field_${field.id}`);
                if (input) {
                  let value = input.value;

                  // Convertir seg√∫n tipo
                  if (field.type === 'number') {
                    value = value ? parseFloat(value) : null;
                  } else if (field.type === 'date') {
                    // Ya est√° en formato ISO desde flatpickr
                    value = value || '';
                  } else if (field.type === 'priority') {
                    value = value || '';
                  } else {
                    // texto
                    value = value || '';
                  }

                  customFieldsValues[field.id] = value;
                }
              });
            }

            // Notificar ANTES del await (evita bloqueos)
            if (f_notifyOnSave && f_notifyOnSave.checked) {
              const draftId = (dialogMode === "edit" && editingId != null) ? String(editingId) : "NUEVA";
              const createdForDraft = (dialogMode === "edit" && editingId != null)
                ? (state.tasks.find(x => x.id === editingId)?.creada || nowIso)
                : nowIso;

              notifyByEmailDraft({
                id: draftId,
                workspaceId: wsId,
                workspaceName: workspaceNameById(wsId) || "",
                nombre: f_name.value.trim(),
                descripcion: f_desc.value.trim(),
                responsableEmail: email,
                responsableNombre: nombreResp,
                estado: f_status.value,
                creada: createdForDraft,
                modificada: nowIso,
                fechaTermino: dueStr,
                customFields: customFieldsValues
              });
            }

            if (dialogMode === "create") {
              if (!createRequestId) createRequestId = makeUUID();

              const task = {
                id: 0,
                workspaceId: wsId,
                nombre: f_name.value.trim(),
                descripcion: f_desc.value.trim(),
                responsableEmail: email,
                estado: f_status.value,
                creada: nowIso,
                modificada: nowIso,
                fechaTermino: dueStr,
                fechaCierre: (f_status.value === "Cerrada") ? nowIso : "",
                adjuntos: [],
                customFields: customFieldsValues,
                clientRequestId: createRequestId
              };

              const res = await gs("upsertTarea", task);
              if (!res || !res.ok) { alert("No se pudo guardar: " + (res?.error || "Error desconocido")); return; }

              let saved = res.data;
              saved.adjuntos = Array.isArray(saved.adjuntos) ? saved.adjuntos : [];
              saved.customFields = saved.customFields || {};

              if (pendingFiles.length > 0) {
                const updatedAdj = await uploadPendingFiles(saved.id);
                saved.adjuntos = updatedAdj;
              }

              state.tasks = [saved, ...state.tasks.filter(t => t.id !== saved.id)];
              closeTaskModal();
              renderAll();
              renderSidebar();
              return;
            }

            if (dialogMode === "edit" && editingId != null) {
              const t = state.tasks.find(x => x.id === editingId);
              if (!t) return;

              const newStatus = f_status.value;
              const prevStatus = t.estado;

              const task = {
                ...t,
                workspaceId: wsId,
                nombre: f_name.value.trim(),
                descripcion: f_desc.value.trim(),
                responsableEmail: email,
                estado: newStatus,
                modificada: nowIso,
                fechaTermino: dueStr,
                fechaCierre: t.fechaCierre || "",
                adjuntos: Array.isArray(t.adjuntos) ? t.adjuntos : [],
                customFields: customFieldsValues
              };

              if (newStatus === "Cerrada" && !task.fechaCierre) task.fechaCierre = nowIso;
              if (newStatus !== "Cerrada" && prevStatus === "Cerrada") task.fechaCierre = "";

              const res = await gs("upsertTarea", task);
              if (!res || !res.ok) { alert("No se pudo guardar: " + (res?.error || "Error desconocido")); return; }

              let saved = res.data;
              saved.adjuntos = Array.isArray(saved.adjuntos) ? saved.adjuntos : (task.adjuntos || []);
              saved.customFields = saved.customFields || {};

              if (pendingFiles.length > 0) {
                const updatedAdj = await uploadPendingFiles(saved.id);
                saved.adjuntos = updatedAdj;
              }

              state.tasks = state.tasks.map(x => x.id === saved.id ? saved : x);
              closeTaskModal();
              renderAll();
              renderSidebar();
            }
          } catch (err) {
            alert("Error guardando: " + (err?.message || err));
          } finally {
            savingTask = false;
            btn.disabled = false;
            btn.textContent = prevTxt;
          }
        });

        // Responsables modal
        btnCloseResp.addEventListener("click", closeRespModal);
        btnRespDone.addEventListener("click", closeRespModal);
        respBackdrop.addEventListener("click", (e) => { if (e.target === respBackdrop) closeRespModal(); });

        btnClearResp.addEventListener("click", () => {
          r_name.value = "";
          r_email.value = "";
          r_email.disabled = false;
          r_name.focus();
        });

        btnAddResp.addEventListener("click", saveResponsableFlow);

        // Overdue backdrop click
        overdueBackdrop.addEventListener("click", (e) => { if (e.target === overdueBackdrop) closeOverdueModal(); });

        // ===== Listeners para admin espacios =====
        btnCloseAdminWS.addEventListener("click", closeWSAdmin);
        btnAdminWSDone.addEventListener("click", closeWSAdmin);
        adminWSBackdrop.addEventListener("click", (e) => {
          if (e.target === adminWSBackdrop) closeWSAdmin();
        });

        btnCreateNewWS.addEventListener("click", createWSFromAdmin);
        btnClearNewWS.addEventListener("click", () => {
          newWSName.value = '';
          newWSName.focus();
        });

        // Enter en input de nuevo espacio
        newWSName.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            createWSFromAdmin();
          }
        });

        // Listeners para modal de confirmaci√≥n de eliminaci√≥n
        btnCancelDeleteWS.addEventListener("click", () => {
          confirmDeleteWSBackdrop.classList.remove("show");
          wsToDelete = null;
          wsToDeleteId = null;
        });

        confirmDeleteWSBackdrop.addEventListener("click", (e) => {
          if (e.target === confirmDeleteWSBackdrop) {
            confirmDeleteWSBackdrop.classList.remove("show");
            wsToDelete = null;
            wsToDeleteId = null;
          }
        });

        // Opciones de eliminaci√≥n
        document.querySelectorAll('input[name="deleteOption"]').forEach(radio => {
          radio.addEventListener('change', updateDeleteOptionUI);
        });

        // Bot√≥n confirmar eliminaci√≥n
        btnConfirmDeleteWS.addEventListener("click", async () => {
          if (!wsToDeleteId) return;

          const selectedOption = document.querySelector('input[name="deleteOption"]:checked').value;

          switch (selectedOption) {
            case 'move':
              const targetWsId = Number(moveToWSSelect.value);
              if (!targetWsId || isNaN(targetWsId)) {
                alert('Selecciona un espacio destino v√°lido');
                return;
              }
              await moveTasksAndDeleteWS(wsToDeleteId, targetWsId);
              break;

            case 'hide':
              await toggleWSVisibility(wsToDeleteId, true);
              confirmDeleteWSBackdrop.classList.remove("show");
              break;

            case 'deleteAll':
              if (confirm(`‚ö†Ô∏è ¬øEST√ÅS SEGURO?\n\nSe eliminar√°n PERMANENTEMENTE ${countTasksInWorkspace(wsToDeleteId)} tarea(s) y el
  espacio "${wsToDelete.nombre}".\n\nEsta acci√≥n NO SE PUEDE DESHACER.`)) {
                await deleteWorkspaceWithTasks(wsToDeleteId);
              }
              break;
          }

          wsToDelete = null;
          wsToDeleteId = null;
        });

        // ===== Listeners para admin campos personalizados =====
        btnCloseManageFields.addEventListener("click", closeManageFieldsModal);
        btnManageFieldsDone.addEventListener("click", closeManageFieldsModal);
        manageFieldsBackdrop.addEventListener("click", (e) => {
          if (e.target === manageFieldsBackdrop) closeManageFieldsModal();
        });

        btnAddCustomField.addEventListener("click", addCustomField);
        btnClearNewField.addEventListener("click", () => {
          newFieldName.value = '';
          newFieldType.value = 'text';
          newFieldName.focus();
        });

        // Enter en input de nuevo campo
        newFieldName.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            addCustomField();
          }
        });
      }

      function setView(which) {
        if (which === "board") {
          viewBoard.classList.remove("hidden");
          viewTable.classList.add("hidden");
          viewAll.classList.add("hidden");
          btnViewBoard.classList.add("active");
          btnViewTable.classList.remove("active");
          btnViewAll.classList.remove("active");
          viewTitle.textContent = "Vista: Tablero";
        } else if (which === "table") {
          viewTable.classList.remove("hidden");
          viewBoard.classList.add("hidden");
          viewAll.classList.add("hidden");
          btnViewTable.classList.add("active");
          btnViewBoard.classList.remove("active");
          btnViewAll.classList.remove("active");
          viewTitle.textContent = "Vista: Tabla";
        } else if (which === "all") {
          viewAll.classList.remove("hidden");
          viewBoard.classList.add("hidden");
          viewTable.classList.add("hidden");
          btnViewAll.classList.add("active");
          btnViewBoard.classList.remove("active");
          btnViewTable.classList.remove("active");
          viewTitle.textContent = "Vista: Todas las tareas";
          renderAllTasks();
        }
      }

      function renderSidebar() {
        wsList.innerHTML = "";

        const activeCount = state.workspaces.filter(w => w.activo).length;
        const respActive = state.responsables.filter(r => r.activo !== false).length;
        const fieldsCount = state.customFields.length;
        const totalSysTasks = state.tasks.length;

        sbCounts.textContent = `Espacios: ${activeCount} ¬∑ Resp: ${respActive} ¬∑ Campos: ${fieldsCount} ¬∑ Total Tareas: ${totalSysTasks}`;

        for (const ws of state.workspaces.filter(w => w.activo)) {
          const div = document.createElement("div");
          div.className = "ws-item" + (ws.id === state.currentWorkspaceId ? " active" : "");
          div.innerHTML = `
  <div class="dot"></div>
  <div style="display:flex; flex-direction:column; gap:3px; flex: 1;">
    <div class="name">${escapeHtml(ws.nombre)}</div>
  </div>
  `;

          div.addEventListener("click", () => {
            state.currentWorkspaceId = ws.id;
            renderSidebar();
            renderAll();
          });

          div.addEventListener("dragover", (ev) => {
            ev.preventDefault();
            div.classList.add("drop-highlight");
          });
          div.addEventListener("dragleave", () => div.classList.remove("drop-highlight"));
          div.addEventListener("drop", async (ev) => {
            ev.preventDefault();
            div.classList.remove("drop-highlight");
            const id = ev.dataTransfer.getData("text/plain");
            if (!id) return;
            const taskId = parseInt(id, 10);
            if (isNaN(taskId)) {
              console.error("ID de tarea inv√°lido:", id);
              return;
            }
            console.log("Moviendo tarea", taskId, "a workspace", ws.id);
            await moveTaskToWorkspace(taskId, ws.id);
          });

          wsList.appendChild(div);
        }
      }

      // ===== Funciones para campos personalizados =====

      // ===== Funciones para modal de configuraci√≥n =====
      function openConfigModal() {
        configBackdrop.classList.add("show");
      }

      function closeConfigModal() {
        configBackdrop.classList.remove("show");
      }

      function openManageFieldsModal() {
        renderFieldsConfig();
        manageFieldsBackdrop.classList.add("show");
        newFieldName.focus();
      }

      function closeManageFieldsModal() {
        manageFieldsBackdrop.classList.remove("show");
      }

      async function addCustomField() {
        const name = newFieldName.value.trim();
        const type = newFieldType.value;

        if (!name) {
          alert('Ingresa un nombre para el campo');
          newFieldName.focus();
          return;
        }

        // Verificar que no exista un campo con el mismo nombre
        if (state.customFields.some(f => f.name.toLowerCase() === name.toLowerCase())) {
          alert('Ya existe un campo con ese nombre');
          newFieldName.focus();
          return;
        }

        try {
          const field = {
            id: makeFieldId(),
            name: name,
            type: type,
            order: state.customFields.length
          };

          const res = await gs("upsertCustomField", field);
          if (!res || !res.ok) throw new Error("No se pudo guardar el campo");

          state.customFields.push(res.data);

          newFieldName.value = '';
          newFieldType.value = 'text';
          newFieldName.focus();

          renderFieldsConfig();

        } catch (err) {
          alert("Error creando campo: " + (err?.message || err));
        }
      }

      async function deleteCustomField(fieldId) {
        if (!confirm('¬øEliminar este campo? Esto tambi√©n eliminar√° los valores de este campo en todas las tareas.')) {
          return;
        }

        try {
          const res = await gs("deleteCustomField", fieldId);
          if (!res || !res.ok) throw new Error("No se pudo eliminar el campo");

          state.customFields = state.customFields.filter(f => f.id !== fieldId);

          // Actualizar tareas para remover este campo
          state.tasks.forEach(task => {
            if (task.customFields && task.customFields[fieldId] !== undefined) {
              delete task.customFields[fieldId];
            }
          });

          renderFieldsConfig();

        } catch (err) {
          alert("Error eliminando campo: " + (err?.message || err));
        }
      }

      function renderFieldsConfig() {
        fieldsConfigContainer.innerHTML = '';

        if (state.customFields.length === 0) {
          emptyFieldsMessage.style.display = 'block';
          fieldsCount.textContent = 'Total: 0';
          return;
        }

        emptyFieldsMessage.style.display = 'none';
        fieldsCount.textContent = `Total: ${state.customFields.length}`;

        // Ordenar por order
        const sortedFields = [...state.customFields].sort((a, b) => a.order - b.order);

        sortedFields.forEach((field, index) => {
          const fieldType = FIELD_TYPES.find(t => t.value === field.type) || FIELD_TYPES[0];

          const row = document.createElement('div');
          row.className = 'field-config-row';
          row.innerHTML = `
  <div>
    <label style="margin-bottom:4px; font-size:11px; color:var(--muted);">Nombre</label>
    <input type="text" value="${escapeHtml(field.name)}" class="field-name-input" data-field-id="${field.id}"
      style="width:100%;" maxlength="50" />
  </div>
  <div>
    <label style="margin-bottom:4px; font-size:11px; color:var(--muted);">Tipo</label>
    <div class="custom-field-value" style="display:flex; align-items:center; gap:8px;">
      <span class="field-type-icon">${fieldType.icon}</span>
      <span>${fieldType.label}</span>
    </div>
  </div>
  <div class="field-config-actions">
    <button class="secondary mini danger-btn" type="button" data-act="delete">Eliminar</button>
  </div>
  `;

          // Actualizar nombre
          const nameInput = row.querySelector('.field-name-input');
          nameInput.addEventListener('change', async () => {
            const newName = nameInput.value.trim();
            if (!newName) {
              alert('El nombre no puede estar vac√≠o');
              nameInput.value = field.name;
              return;
            }

            if (newName === field.name) return;

            // Verificar que no exista otro campo con el mismo nombre
            if (state.customFields.some(f => f.id !== field.id && f.name.toLowerCase() === newName.toLowerCase())) {
              alert('Ya existe otro campo con ese nombre');
              nameInput.value = field.name;
              return;
            }

            try {
              const updatedField = { ...field, name: newName };
              const res = await gs("upsertCustomField", updatedField);
              if (!res || !res.ok) throw new Error("No se pudo actualizar el campo");

              field.name = newName;
              renderFieldsConfig();

            } catch (err) {
              alert("Error actualizando campo: " + (err?.message || err));
              nameInput.value = field.name;
            }
          });

          // Bot√≥n eliminar
          row.querySelector('[data-act="delete"]').addEventListener('click', () => {
            deleteCustomField(field.id);
          });

          fieldsConfigContainer.appendChild(row);
        });
      }

      function renderCustomFieldsInTaskModal(task = null) {
        customFieldsContainer.innerHTML = '';

        if (!state.customFields || state.customFields.length === 0) {
          noCustomFieldsMsg.style.display = 'block';
          customFieldsCount.textContent = '0';
          return;
        }

        noCustomFieldsMsg.style.display = 'none';
        customFieldsCount.textContent = state.customFields.length.toString();

        // Ordenar por order
        const sortedFields = [...state.customFields].sort((a, b) => a.order - b.order);

        sortedFields.forEach(field => {
          const fieldType = FIELD_TYPES.find(t => t.value === field.type) || FIELD_TYPES[0];
          const fieldId = `custom_field_${field.id}`;

          // Obtener valor actual si existe
          const currentValue = task && task.customFields ? task.customFields[field.id] : '';

          const fieldElement = document.createElement('div');
          fieldElement.className = 'custom-field-item';

          // Crear input seg√∫n tipo
          let inputHTML = '';

          switch (field.type) {
            case 'text':
              inputHTML = `<input type="text" id="${fieldId}" value="${escapeHtml(currentValue || '')}"
    placeholder="Ingresa texto..." />`;
              break;

            case 'number':
              inputHTML = `<input type="number" id="${fieldId}" value="${currentValue || ''}" placeholder="0" step="any" />`;
              break;

            case 'date':
              inputHTML = `
  <div style="display:flex; gap:8px; align-items:center;">
    <input type="text" id="${fieldId}" value="${currentValue ? formatDMYHM(new Date(currentValue)) : ''}" readonly
      placeholder="DD-MM-YYYY" style="flex:1;" />
    <button type="button" class="secondary cal-btn mini" data-field-id="${field.id}" style="width:44px;">üìÖ</button>
  </div>
  `;
              break;

            case 'priority':
              const priorityOptions = PRIORITY_OPTIONS.map(opt =>
                `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`
              ).join('');
              inputHTML = `<select id="${fieldId}">
    <option value="">Seleccionar...</option>${priorityOptions}
  </select>`;
              break;

            default:
              inputHTML = `<input type="text" id="${fieldId}" value="${escapeHtml(currentValue || '')}" />`;
          }

          fieldElement.innerHTML = `
  <div>
    <label style="margin-bottom:4px; font-size:11px; color:var(--muted);">${escapeHtml(field.name)}</label>
    ${inputHTML}
  </div>
  <div>
    <label style="margin-bottom:4px; font-size:11px; color:var(--muted);">Tipo</label>
    <div class="custom-field-value" style="display:flex; align-items:center; gap:8px;">
      <span class="field-type-icon">${fieldType.icon}</span>
      <span>${fieldType.label}</span>
    </div>
  </div>
  <div style="display:flex; align-items:center;">
    <span class="custom-field-pill">ID: ${field.id}</span>
  </div>
  `;

          customFieldsContainer.appendChild(fieldElement);

          // Inicializar datepicker si es tipo fecha
          if (field.type === 'date') {
            setTimeout(() => {
              initCustomFieldDatePicker(field.id, currentValue);
            }, 100);
          }
        });
      }

      function initCustomFieldDatePicker(fieldId, currentValue) {
        const inputId = `custom_field_${fieldId}`;
        const input = document.getElementById(inputId);
        const button = document.querySelector(`[data-field-id="${fieldId}"]`);

        if (!input || !window.flatpickr) return;

        // Destruir datepicker anterior si existe
        if (fieldDatePickers[fieldId]) {
          fieldDatePickers[fieldId].destroy();
        }

        const fp = flatpickr(input, {
          enableTime: fieldId.includes('_time'), // Podr√≠amos agregar soporte para hora si es necesario
          time_24hr: true,
          minuteIncrement: 5,
          allowInput: false,
          clickOpens: false,
          disableMobile: true,
          dateFormat: "d-m-Y",
          static: true,
          onChange: (selectedDates) => {
            if (selectedDates && selectedDates[0]) {
              const d = selectedDates[0];
              const isoDate = d.toISOString();
              // Guardar en formato ISO
              input.value = formatDMY(d);
              input.dataset.isoValue = isoDate;
            } else {
              input.value = '';
              input.dataset.isoValue = '';
            }
          }
        });

        // Establecer fecha actual si existe
        if (currentValue) {
          try {
            const date = new Date(currentValue);
            if (!isNaN(date.getTime())) {
              fp.setDate(date, false);
              input.value = formatDMY(date);
              input.dataset.isoValue = date.toISOString();
            }
          } catch (e) {
            console.error('Error parsing date:', e);
          }
        }

        // Bot√≥n para abrir datepicker
        if (button) {
          button.addEventListener('click', () => fp.open());
        }

        input.addEventListener('click', () => fp.open());

        // Guardar referencia
        fieldDatePickers[fieldId] = fp;
      }

      function formatDMY(date) {
        const dd = String(date.getDate()).padStart(2, "0");
        const mm = String(date.getMonth() + 1).padStart(2, "0");
        const yy = date.getFullYear();
        return `${dd}-${mm}-${yy}`;
      }

      function makeFieldId() {
        return 'field_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }

      function getCustomFieldValue(field, value) {
        if (!value) return '';

        switch (field.type) {
          case 'date':
            try {
              const date = new Date(value);
              return isNaN(date.getTime()) ? value : formatDMY(date);
            } catch (e) {
              return value;
            }

          case 'priority':
            return `<span class="priority-badge priority-${value.toLowerCase()}">${value}</span>`;

          default:
            return escapeHtml(String(value));
        }
      }

      function renderCustomFieldsInCard(task) {
        if (!state.customFields || state.customFields.length === 0 || !task.customFields) return '';

        const fieldsWithValues = state.customFields.filter(field =>
          task.customFields && task.customFields[field.id] !== undefined && task.customFields[field.id] !== ''
        );

        if (fieldsWithValues.length === 0) return '';

        return fieldsWithValues.map(field => {
          const value = task.customFields[field.id];
          const displayValue = getCustomFieldValue(field, value);
          const fieldType = FIELD_TYPES.find(t => t.value === field.type) || FIELD_TYPES[0];

          return `
  <span class="pill" title="${escapeHtml(field.name)}: ${escapeHtml(String(value))}">
    ${fieldType.icon} ${escapeHtml(field.name)}: ${displayValue}
  </span>
  `;
        }).join('');
      }

      function renderCustomFieldsInTable(task) {
        if (!state.customFields || state.customFields.length === 0 || !task.customFields) return '';

        const fieldsWithValues = state.customFields.filter(field =>
          task.customFields && task.customFields[field.id] !== undefined && task.customFields[field.id] !== ''
        );

        if (fieldsWithValues.length === 0) return '‚Äî';

        return fieldsWithValues.map(field => {
          const value = task.customFields[field.id];
          const displayValue = getCustomFieldValue(field, value);
          const fieldType = FIELD_TYPES.find(t => t.value === field.type) || FIELD_TYPES[0];

          return `
  <div style="margin-bottom:4px; font-size:11px;">
    <strong>${fieldType.icon} ${escapeHtml(field.name)}:</strong> ${displayValue}
  </div>
  `;
        }).join('');
      }

      // ===== Funci√≥n para abrir el administrador de espacios =====
      function openWSAdmin() {
        renderWSAdminTable();
        adminWSBackdrop.classList.add("show");
      }

      function closeWSAdmin() {
        adminWSBackdrop.classList.remove("show");
        renderSidebar();
        renderAll();
      }

      // ===== Funci√≥n para contar tareas por espacio =====
      function countTasksInWorkspace(workspaceId) {
        return state.tasks.filter(t => String(t.workspaceId) === String(workspaceId)).length;
      }

      // ===== Funci√≥n para renderizar tabla de administraci√≥n =====
      function renderWSAdminTable() {
        adminWSTbody.innerHTML = "";

        // Ordenar: activos primero, luego por nombre
        const sortedWS = [...state.workspaces].sort((a, b) => {
          if ((a.activo !== false) !== (b.activo !== false)) {
            return (a.activo !== false) ? -1 : 1;
          }
          return (a.nombre || "").localeCompare(b.nombre || "", "es");
        });

        let totalTasks = 0;
        let activeCount = 0;
        let hiddenCount = 0;

        for (const ws of sortedWS) {
          const taskCount = countTasksInWorkspace(ws.id);
          totalTasks += taskCount;

          if (ws.activo !== false) {
            activeCount++;
          } else {
            hiddenCount++;
          }

          const tr = document.createElement("tr");

          // Determinar clase para el contador de tareas
          const taskCountClass = taskCount === 0 ? "empty" : "has-tasks";
          const taskCountText = taskCount === 0 ? "Vac√≠o" : `${taskCount} tarea(s)`;

          // Determinar estado y botones
          const statusText = ws.activo !== false ? "üü¢ Visible" : "üü° Oculto";
          const statusClass = ws.activo !== false ? "ws-status-active" : "ws-status-hidden";

          tr.innerHTML = `
  <td style="padding:10px; border-bottom:1px solid var(--border);">
    <strong>${ws.id}</strong>
  </td>
  <td style="padding:10px; border-bottom:1px solid var(--border);">
    <span class="editable-ws-name" data-ws-id="${ws.id}">
      ${escapeHtml(ws.nombre || "Sin nombre")}
    </span>
  </td>
  <td style="padding:10px; border-bottom:1px solid var(--border);">
    <span class="pill ${statusClass}">${statusText}</span>
  </td>
  <td style="padding:10px; border-bottom:1px solid var(--border);">
    <span class="ws-task-count ${taskCountClass}">${taskCountText}</span>
  </td>
  <td style="padding:10px; border-bottom:1px solid var(--border);">
    <div class="ws-actions">
      ${ws.activo !== false
              ? `<button class="secondary mini ws-btn-hide" data-act="hide" type="button">Ocultar</button>`
              : `<button class="secondary mini ws-btn-show" data-act="show" type="button">Mostrar</button>`}
      <button class="secondary mini ws-btn-rename" data-act="rename" type="button">Editar</button>
      <button class="secondary mini ws-btn-delete" data-act="delete" type="button" ${taskCount > 0 ? 'disabled' :
              ''}>Eliminar</button>
    </div>
  </td>
  `;

          // Hacer nombre editable con doble clic
          const nameSpan = tr.querySelector('.editable-ws-name');
          nameSpan.addEventListener('dblclick', () => startEditingWSName(ws.id, nameSpan));

          // Bot√≥n Ocultar/Mostrar
          const hideShowBtn = tr.querySelector('[data-act="hide"], [data-act="show"]');
          if (hideShowBtn) {
            hideShowBtn.addEventListener('click', () => toggleWSVisibility(ws.id, ws.activo !== false));
          }

          // Bot√≥n Editar
          const renameBtn = tr.querySelector('[data-act="rename"]');
          if (renameBtn) {
            renameBtn.addEventListener('click', () => startEditingWSName(ws.id, nameSpan));
          }

          // Bot√≥n Eliminar
          const deleteBtn = tr.querySelector('[data-act="delete"]');
          if (deleteBtn) {
            deleteBtn.addEventListener('click', () => deleteWorkspaceFlow(ws.id));
          }

          adminWSTbody.appendChild(tr);
        }

        // Actualizar contadores
        wsAdminCount.textContent = `Total: ${sortedWS.length}`;
        activeWSCount.textContent = `Activos: ${activeCount}`;
        hiddenWSCount.textContent = `Ocultos: ${hiddenCount}`;
        tasksInWSCount.textContent = `Tareas: ${totalTasks}`;
      }

      // ===== Funci√≥n para empezar a editar nombre de espacio =====
      function startEditingWSName(wsId, element) {
        if (editingWSName) {
          // Si ya hay uno editando, cancelar
          stopEditingWSName();
        }

        const ws = state.workspaces.find(w => w.id === wsId);
        if (!ws) return;

        editingWSName = wsId;
        element.classList.add('editing');

        const currentName = ws.nombre || '';
        element.innerHTML = `
  <input type="text" value="${escapeHtml(currentName)}"
    style="width:100%; padding:4px 8px; border-radius:6px; border:1px solid var(--accent);" maxlength="100" />
  <div style="display:flex; gap:4px; margin-top:4px;">
    <button class="secondary mini" data-act="save-name" style="font-size:11px; padding:2px 6px;">Guardar</button>
    <button class="secondary mini" data-act="cancel-name" style="font-size:11px; padding:2px 6px;">Cancelar</button>
  </div>
  `;

        const input = element.querySelector('input');
        input.focus();
        input.select();

        // Guardar al presionar Enter
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            saveWSName(wsId, input.value.trim());
          }
        });

        // Bot√≥n Guardar
        element.querySelector('[data-act="save-name"]').addEventListener('click', () => {
          saveWSName(wsId, input.value.trim());
        });

        // Bot√≥n Cancelar
        element.querySelector('[data-act="cancel-name"]').addEventListener('click', () => {
          stopEditingWSName();
          renderWSAdminTable();
        });
      }

      // ===== Funci√≥n para guardar nombre de espacio =====
      async function saveWSName(wsId, newName) {
        if (!newName || newName.trim() === '') {
          alert('El nombre no puede estar vac√≠o');
          return;
        }

        const ws = state.workspaces.find(w => w.id === wsId);
        if (!ws) return;

        if (ws.nombre === newName) {
          stopEditingWSName();
          renderWSAdminTable();
          return;
        }

        try {
          const res = await gs("upsertWorkspace", {
            id: wsId,
            nombre: newName.trim(),
            activo: ws.activo !== false
          });

          if (!res || !res.ok) throw new Error("No se pudo actualizar el nombre");

          // Actualizar en estado local
          const idx = state.workspaces.findIndex(w => w.id === wsId);
          if (idx >= 0) {
            state.workspaces[idx] = res.data;
          }

          // Si es el espacio actual, actualizar UI
          if (state.currentWorkspaceId === wsId) {
            renderSidebar();
            renderWorkspaceBadge();
          }

          stopEditingWSName();
          renderWSAdminTable();

        } catch (err) {
          alert("Error actualizando nombre: " + (err?.message || err));
        }
      }

      // ===== Funci√≥n para detener edici√≥n =====
      function stopEditingWSName() {
        editingWSName = null;
      }

      // ===== Funci√≥n para cambiar visibilidad de espacio =====
      async function toggleWSVisibility(wsId, isCurrentlyActive) {
        const ws = state.workspaces.find(w => w.id === wsId);
        if (!ws) return;

        const newActiveState = !isCurrentlyActive;

        try {
          const res = await gs("upsertWorkspace", {
            id: wsId,
            nombre: ws.nombre,
            activo: newActiveState
          });

          if (!res || !res.ok) throw new Error("No se pudo cambiar visibilidad");

          // Actualizar en estado local
          const idx = state.workspaces.findIndex(w => w.id === wsId);
          if (idx >= 0) {
            state.workspaces[idx] = res.data;
          }

          // Si estamos ocultando el espacio actual, cambiar a otro activo
          if (state.currentWorkspaceId === wsId && !newActiveState) {
            const firstActive = state.workspaces.find(w => w.activo !== false && w.id !== wsId);
            if (firstActive) {
              state.currentWorkspaceId = firstActive.id;
            }
          }

          renderWSAdminTable();
          renderSidebar();
          renderAll();

        } catch (err) {
          alert("Error cambiando visibilidad: " + (err?.message || err));
        }
      }

      // ===== Funci√≥n para crear nuevo espacio desde admin =====
      async function createWSFromAdmin() {
        const name = newWSName.value.trim();
        if (!name) {
          alert('Ingresa un nombre para el espacio');
          newWSName.focus();
          return;
        }

        try {
          const res = await gs("upsertWorkspace", {
            nombre: name,
            activo: true
          });

          if (!res || !res.ok) throw new Error("No se pudo crear espacio");

          state.workspaces = [res.data, ...state.workspaces];
          state.currentWorkspaceId = res.data.id;

          newWSName.value = '';
          newWSName.focus();

          renderWSAdminTable();
          renderSidebar();
          renderAll();

        } catch (err) {
          alert("Error creando espacio: " + (err?.message || err));
        }
      }

      // ===== Funci√≥n para flujo de eliminaci√≥n de espacio =====
      function deleteWorkspaceFlow(wsId) {
        const ws = state.workspaces.find(w => w.id === wsId);
        if (!ws) return;

        const taskCount = countTasksInWorkspace(wsId);

        // Si no hay tareas, eliminar directamente
        if (taskCount === 0) {
          if (confirm(`¬øEliminar el espacio "${ws.nombre}"? Esta acci√≥n no se puede deshacer.`)) {
            deleteWorkspace(wsId);
          }
          return;
        }

        // Si hay tareas, mostrar modal de confirmaci√≥n con opciones
        wsToDelete = ws;
        wsToDeleteId = wsId;
        wsToDeleteName.textContent = ws.nombre;
        wsToDeleteTaskCount.textContent = taskCount;
        deleteAllTaskCount.textContent = taskCount;

        // Limpiar selecci√≥n anterior
        document.querySelectorAll('input[name="deleteOption"]').forEach(radio => {
          radio.checked = false;
        });
        document.getElementById('optionMoveTasks').checked = true;

        // Actualizar select de espacios destino (excluyendo el actual)
        moveToWSSelect.innerHTML = '';
        const otherSpaces = state.workspaces
          .filter(w => w.id !== wsId && w.activo !== false)
          .sort((a, b) => a.nombre.localeCompare(b.nombre, "es"));

        if (otherSpaces.length === 0) {
          moveToWSSelect.innerHTML = '<option value="">No hay otros espacios disponibles</option>';
          moveToWSSelect.disabled = true;
          document.getElementById('optionMoveTasks').disabled = true;
          document.getElementById('optionHideWS').checked = true;
        } else {
          moveToWSSelect.disabled = false;
          document.getElementById('optionMoveTasks').disabled = false;

          otherSpaces.forEach(space => {
            const option = document.createElement('option');
            option.value = space.id;
            option.textContent = `${space.nombre} (ID: ${space.id})`;
            moveToWSSelect.appendChild(option);
          });
        }

        // Mostrar/ocultar secci√≥n de mover seg√∫n opci√≥n seleccionada
        updateDeleteOptionUI();

        // Mostrar modal
        confirmDeleteWSBackdrop.classList.add('show');
      }

      // ===== Actualizar UI seg√∫n opci√≥n seleccionada =====
      function updateDeleteOptionUI() {
        const selectedOption = document.querySelector('input[name="deleteOption"]:checked').value;
        moveTasksSection.style.display = selectedOption === 'move' ? 'block' : 'none';

        if (selectedOption === 'deleteAll') {
          btnConfirmDeleteWS.textContent = 'Eliminar Todo';
          btnConfirmDeleteWS.classList.add('danger-btn');
        } else {
          btnConfirmDeleteWS.textContent = 'Proceder';
          btnConfirmDeleteWS.classList.remove('danger-btn');
        }
      }

      // ===== Funci√≥n para eliminar espacio =====
      async function deleteWorkspace(wsId) {
        try {
          const res = await gs("deleteWorkspace", wsId);
          if (!res || !res.ok) throw new Error(res?.error || "No se pudo eliminar el espacio");

          // Eliminar del estado local
          state.workspaces = state.workspaces.filter(w => w.id !== wsId);

          // Si era el espacio actual, cambiar a otro
          if (state.currentWorkspaceId === wsId) {
            const firstActive = state.workspaces.find(w => w.activo !== false);
            state.currentWorkspaceId = firstActive ? firstActive.id : 0;
          }

          // Cerrar modales
          confirmDeleteWSBackdrop.classList.remove('show');

          // Actualizar UI
          renderWSAdminTable();
          renderSidebar();
          renderAll();

          alert('Espacio eliminado exitosamente');

        } catch (err) {
          alert("Error eliminando espacio: " + (err?.message || err));
        }
      }

      // ===== Funci√≥n para mover tareas y eliminar espacio =====
      async function moveTasksAndDeleteWS(sourceWsId, targetWsId) {
        try {
          const res = await gs("moveTasksToWorkspace", sourceWsId, targetWsId);
          if (!res || !res.ok) throw new Error(res?.error || "No se pudieron mover las tareas");

          // Actualizar tareas en estado local
          const movedTasks = state.tasks.filter(t => Number(t.workspaceId) === Number(sourceWsId));
          movedTasks.forEach(task => {
            task.workspaceId = targetWsId;
          });

          // Ahora eliminar el espacio vac√≠o
          await deleteWorkspace(sourceWsId);

        } catch (err) {
          alert("Error moviendo tareas: " + (err?.message || err));
        }
      }

      // ===== Funci√≥n para eliminar espacio con todas sus tareas =====
      async function deleteWorkspaceWithTasks(wsId) {
        try {
          // Primero eliminar todas las tareas del espacio
          const tasksToDelete = state.tasks.filter(t => Number(t.workspaceId) === Number(wsId));

          for (const task of tasksToDelete) {
            const res = await gs("deleteTarea", task.id);
            if (!res || !res.ok) {
              throw new Error(`No se pudo eliminar tarea ${task.id}`);
            }
          }

          // Actualizar estado local
          state.tasks = state.tasks.filter(t => Number(t.workspaceId) !== Number(wsId));

          // Ahora eliminar el espacio
          await deleteWorkspace(wsId);

        } catch (err) {
          alert("Error eliminando espacio con tareas: " + (err?.message || err));
        }
      }

      function populateWorkspaceSelect(selectedId) {
        const activeWS = state.workspaces.filter(w => w.activo);
        f_wsSelect.innerHTML = "";
        for (const w of activeWS) {
          const opt = document.createElement("option");
          opt.value = String(w.id);
          opt.textContent = w.nombre;
          f_wsSelect.appendChild(opt);
        }
        const pick = Number(selectedId) || state.currentWorkspaceId || (activeWS[0]?.id || 0);
        if (pick) f_wsSelect.value = String(pick);
      }

      function populateResponsibleSelect() {
        const actives = state.responsables.filter(r => r.activo !== false);
        f_resp.innerHTML = `<option value="">(Sin asignar)</option>`;
        for (const r of actives) {
          const opt = document.createElement("option");
          opt.value = r.email;
          opt.textContent = `${r.nombre} <${r.email}>`;
          f_resp.appendChild(opt);
        }
      }

      function responsibleLabelByEmail(email) {
        if (!email) return "";
        const r = state.responsables.find(x => x.email === email);
        return r ? (r.nombre || "") : "";
      }

      function responsibleDisplay(t, includeEmail = false) {
        const email = (t.responsableEmail || "").trim().toLowerCase();
        if (!email) {
          return (t.responsableNombre || "").trim();
        }
        const r = state.responsables.find(x => (x.email || "").toLowerCase() === email);
        if (r && r.nombre) {
          return includeEmail ? `${r.nombre} <${email}>` : r.nombre;
        }
        return email;
      }

      // ===== Overdue =====
      function isOverdue(t) {
        if (!t || !t.fechaTermino) return false;
        if (String(t.estado || "").trim() === "Cerrada") return false;
        const d = parseDueDate(t.fechaTermino);
        if (!d) return false;
        return d.getTime() < Date.now();
      } function getOverdueTasks(all = true) {
        const tasks = all ? state.tasks :
          state.tasks.filter(t => String(t.workspaceId) === String(state.currentWorkspaceId));
        return tasks.filter(isOverdue);
      }

      function renderOverdueBadge() {
        const n = getOverdueTasks(true).length;
        overdueCount.textContent = String(n);
      }

      function openOverdueModal() {
        renderOverdueModal();
        overdueBackdrop.classList.add("show");
      }
      function closeOverdueModal() {
        overdueBackdrop.classList.remove("show");
      }

      function renderOverdueModal() {
        const overdue = getOverdueTasks(true).sort((a, b) => {
          const da = parseDueDate(a.fechaTermino)?.getTime() || 0;
          const db = parseDueDate(b.fechaTermino)?.getTime() || 0;
          return da - db;
        });

        overdueSummary.textContent = `Total vencidas: ${overdue.length}`;
        overdueTbody.innerHTML = "";

        for (const t of overdue) {
          const wsName = workspaceNameById(t.workspaceId) || "‚Äî";
          const tr = document.createElement("tr");
          tr.className = "row-overdue";
          tr.innerHTML = `
        <td><strong>#${t.id}</strong></td>
        <td>${escapeHtml(wsName)}</td>
        <td>${escapeHtml(t.nombre || "")}</td>
        <td>${escapeHtml(responsibleDisplay(t) || "‚Äî")}</td>
        <td>${escapeHtml(normalizeDueString(t.fechaTermino) || "‚Äî")}</td>
        <td>${escapeHtml(t.estado || "")}</td>
        <td>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="secondary mini" data-act="go" type="button">Ir</button>
            <button class="secondary mini" data-act="edit" type="button">Editar</button>
            <button class="secondary mini" data-act="notify" type="button">Notificar</button>
          </div>
        </td>
        `;
          tr.querySelector('[data-act="go"]').addEventListener("click", () => {
            state.currentWorkspaceId = Number(t.workspaceId) || state.currentWorkspaceId;
            renderSidebar();
            renderAll();
            closeOverdueModal();
          });
          tr.querySelector('[data-act="edit"]').addEventListener("click", () => {
            state.currentWorkspaceId = Number(t.workspaceId) || state.currentWorkspaceId;
            renderSidebar();
            renderAll();
            closeOverdueModal();
            openEdit(t.id);
          });
          tr.querySelector('[data-act="notify"]').addEventListener("click", (e) => {
            e.preventDefault(); e.stopPropagation();
            notifyByEmail(t.id);
          });

          overdueTbody.appendChild(tr);
        }
      }

      function renderAll() {
        const filtered = getFilteredTasks();
        renderStats(filtered);
        renderWorkspaceBadge();
        renderOverdueBadge();
        renderBoard(filtered);
        renderTable(filtered);
        renderAllTasks();
      }

      function renderWorkspaceBadge() {
        const ws = state.workspaces.find(w => w.id === state.currentWorkspaceId);
        wsBadge.textContent = `Espacio: ${ws ? ws.nombre : "‚Äî"}`;
      }

      function getFilteredTasks() {
        const q = (searchEl.value || "").trim().toLowerCase();
        let arr = state.tasks.filter(t => String(t.workspaceId) === String(state.currentWorkspaceId));

        if (q) {
          arr = arr.filter(t => {
            // Buscar en campos b√°sicos
            const basicSearch = `${t.id} ${t.nombre} ${t.descripcion} ${t.responsableNombre} ${t.responsableEmail}
        ${t.fechaTermino}`.toLowerCase();

            // Buscar en campos personalizados
            let customFieldsSearch = "";
            if (t.customFields && state.customFields) {
              state.customFields.forEach(field => {
                if (t.customFields[field.id] !== undefined) {
                  customFieldsSearch += ` ${String(t.customFields[field.id]).toLowerCase()}`;
                }
              });
            }

            return (basicSearch + customFieldsSearch).includes(q);
          });
        }

        arr.sort((a, b) => compareTasks(a, b, sortByEl.value));
        return arr;
      }

      function compareTasks(a, b, mode) {
        const dt = (x) => x ? new Date(x).getTime() : 0;
        const due = (x) => {
          const d = parseDueDate(x);
          return d ? d.getTime() : 0;
        };

        switch (mode) {
          case "id_asc": return String(a.id).localeCompare(String(b.id), undefined, { numeric: true });
          case "id_desc": return String(b.id).localeCompare(String(a.id), undefined, { numeric: true });
          case "created_asc": return dt(a.creada) - dt(b.creada);
          case "created_desc": return dt(b.creada) - dt(a.creada);
          case "updated_asc": return dt(a.modificada) - dt(b.modificada);
          case "updated_desc": return dt(b.modificada) - dt(a.modificada);
          case "due_asc": return due(a.fechaTermino) - due(b.fechaTermino);
          case "due_desc": return due(b.fechaTermino) - due(a.fechaTermino);
          case "status_asc": return String(a.estado).localeCompare(String(b.estado), "es");
          case "resp_asc": return String(responsibleDisplay(a)).localeCompare(String(responsibleDisplay(b)), "es");
          default: return b.id - a.id;
        }
      }

      function renderStats(tasks) {
        const total = tasks.length;
        const counts = STATUSES.map(s => tasks.filter(t => t.estado === s).length);
        statsEl.textContent = `Total ${total} ¬∑ Pend ${counts[0]} ¬∑ Prog ${counts[1]} ¬∑ Rev ${counts[2]} ¬∑ Cerr
        ${counts[3]}`;
      }

      function renderBoard(tasks) {
        boardEl.innerHTML = "";
        for (const status of STATUSES) {
          const col = document.createElement("div");
          col.className = "col";
          col.dataset.status = status;

          const hd = document.createElement("div");
          hd.className = "col-hd";
          hd.innerHTML = `<div class="name">${escapeHtml(status)} <span class="badge">${tasks.filter(t => t.estado ===
            status).length}</span></div>`;
          col.appendChild(hd);

          const dz = document.createElement("div");
          dz.className = "dropzone";
          dz.dataset.status = status;

          dz.addEventListener("dragover", (ev) => {
            ev.preventDefault();
            dz.style.outline = "2px solid rgba(47,124,255,.35)";
            dz.style.borderRadius = "14px";
          });
          dz.addEventListener("dragleave", () => dz.style.outline = "none");
          dz.addEventListener("drop", async (ev) => {
            ev.preventDefault();
            dz.style.outline = "none";
            const id = ev.dataTransfer.getData("text/plain");
            if (!id) return;
            const taskId = parseInt(id, 10);
            if (isNaN(taskId)) {
              console.error("ID de tarea inv√°lido:", id);
              return;
            }
            console.log("Moviendo tarea", taskId, "a estado", status);
            await moveTaskToStatus(taskId, status);
          });

          const colTasks = tasks.filter(t => t.estado === status);
          for (const t of colTasks) {
            dz.appendChild(renderCard(t));
          }
          col.appendChild(dz);
          boardEl.appendChild(col);
        }
      }

      function workspaceNameById(id) {
        const w = state.workspaces.find(x => String(x.id) === String(id));
        return w ? w.nombre : "";
      }

      // Funci√≥n auxiliar para obtener solo la primera l√≠nea de texto
      function getFirstLine(text) {
        if (!text) return "";
        const lines = text.split('\n');
        return lines[0] || "";
      }

      // Funci√≥n auxiliar para formatear solo la fecha (sin hora)
      function formatDateOnly(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "";
        const parts = new Intl.DateTimeFormat("es-CL", {
          timeZone: TZ_CL,
          year: "numeric",
          month: "2-digit",
          day: "2-digit"
        }).formatToParts(d).reduce((acc, p) => {
          acc[p.type] = p.value;
          return acc;
        }, {});
        return `${parts.day}-${parts.month}-${parts.year}`;
      }

      function renderCard(t) {
        const card = document.createElement("div");
        card.className = "card" + (isOverdue(t) ? " overdue" : "");
        card.draggable = true;

        // doble click para editar
        card.addEventListener("dblclick", () => openEdit(t.id));

        card.addEventListener("dragstart", (ev) => {
          ev.dataTransfer.setData("text/plain", String(t.id));
          ev.dataTransfer.effectAllowed = "move";
          card.style.opacity = "0.6";
          console.log("Iniciando arrastre de tarea", t.id);
        });
        card.addEventListener("dragend", (ev) => {
          card.style.opacity = "1";
        });

        // drop de archivos sobre tarjeta
        card.addEventListener("dragover", (ev) => {
          if (ev.dataTransfer && Array.from(ev.dataTransfer.types || []).includes("Files")) {
            ev.preventDefault();
            card.classList.add("drag-over");
          }
        });
        card.addEventListener("dragleave", () => card.classList.remove("drag-over"));

        card.addEventListener("drop", async (ev) => {
          if (!(ev.dataTransfer && ev.dataTransfer.files && ev.dataTransfer.files.length)) return;
          ev.preventDefault();
          ev.stopPropagation();
          card.classList.remove("drag-over");

          try {
            const payload = await filesToPayload(ev.dataTransfer.files);
            const res = await gs("uploadTaskAttachments", t.id, payload);
            if (!res || !res.ok) throw new Error("No se pudo subir adjuntos");

            const updated = Array.isArray(res.data) ? res.data : [];
            const taskRef = state.tasks.find(x => x.id === t.id);
            if (taskRef) taskRef.adjuntos = updated;

            openEdit(t.id);
            renderAll();
          } catch (err) {
            alert("Error subiendo adjuntos: " + (err?.message || err));
          }
        });

        const duePill = getDuePill(t);
        const closedPill = t.fechaCierre ? `<span class="pill ok">Cierre: ${formatDateOnly(t.fechaCierre)}</span>` : "";

        // MODIFICADO: Solo mostrar el nombre del responsable, no el correo
        const respName = responsibleDisplay(t);
        const respPill = respName ? `<span class="pill">Resp: ${escapeHtml(respName)}</span>` : "";

        const attCount = Array.isArray(t.adjuntos) ? t.adjuntos.length : 0;
        const attPill = attCount > 0 ? `<span class="pill">Adjuntos: ${attCount}</span>` : "";

        // Campos personalizados en la tarjeta
        const customFieldsPills = renderCustomFieldsInCard(t);

        // MODIFICADO seg√∫n los requisitos:
        // 1. Solo fecha de creaci√≥n, sin hora
        // 2. Solo nombre del responsable, sin correo
        // 3. Solo primera l√≠nea de la descripci√≥n
        const primeraLineaDesc = getFirstLine(t.descripcion || "");

        card.innerHTML = `
        <div class="row1">
          <div>
            <strong>#${t.id} ‚Äî ${escapeHtml(t.nombre)}</strong>
            <small>Creaci√≥n: ${formatDateOnly(t.creada)}</small>
          </div>
          <span class="badge ${isOverdue(t) ? " danger" : ""}">${escapeHtml(t.estado)}</span>
        </div>

        ${primeraLineaDesc ? `<div class="desc">${escapeHtml(primeraLineaDesc)}</div>` : `<div class="desc"
          style="opacity:.6;">(Sin descripci√≥n)</div>`}

        <div class="meta">
          ${respPill}
          ${duePill}
          ${closedPill}
          ${attPill}
          ${customFieldsPills}
        </div>

        <div class="actions">
          ${t.estado !== "Cerrada"
            ? `<button class="secondary mini" data-act="close" type="button">Cerrar</button>`
            : `<button class="secondary mini" data-act="reopen" type="button">Reabrir</button>`}
          <button class="secondary mini" data-act="notify" type="button">Notificar</button>
        </div>
        `;
        
        // Agregar data-id y data-status para debugging y tracking
        card.dataset.id = String(t.id);
        card.dataset.status = t.estado;

        const closeBtn = card.querySelector('[data-act="close"]');
        if (closeBtn) closeBtn.addEventListener("click", (e) => { e.stopPropagation(); quickClose(t.id); });

        const reopenBtn = card.querySelector('[data-act="reopen"]');
        if (reopenBtn) reopenBtn.addEventListener("click", (e) => { e.stopPropagation(); quickReopen(t.id); });

        const notifyBtn = card.querySelector('[data-act="notify"]');
        if (notifyBtn) notifyBtn.addEventListener("click", (e) => {
          e.preventDefault(); e.stopPropagation();
          notifyByEmail(t.id);
        });

        return card;
      }

      function renderTable(tasks) {
        tbody.innerHTML = "";
        const wsName = workspaceNameById(state.currentWorkspaceId);

        for (const t of tasks) {
          const attCount = Array.isArray(t.adjuntos) ? t.adjuntos.length : 0;
          const customFieldsDisplay = renderCustomFieldsInTable(t);

          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td><strong>#${t.id}</strong></td>
        <td>${escapeHtml(wsName)}</td>
        <td>${escapeHtml(t.nombre)}<div class="muted">${escapeHtml(t.estado)}</div>
        </td>
        <td>${t.descripcion ? escapeHtml(t.descripcion) : `<span class="muted">(Sin descripci√≥n)</span>`}</td>
        <td>${responsibleDisplay(t, true) ? escapeHtml(responsibleDisplay(t, true)) : `<span class="muted">‚Äî</span>`}</td>
        <td>${escapeHtml(t.estado)}</td>
        <td>${fmtDateTimeCL(t.creada)}</td>
        <td>${fmtDateTimeCL(t.modificada)}</td>
        <td>${t.fechaTermino ? escapeHtml(normalizeDueString(t.fechaTermino)) : `<span class="muted">‚Äî</span>`}</td>
        <td>${t.fechaCierre ? fmtDateTimeCL(t.fechaCierre) : `<span class="muted">‚Äî</span>`}</td>
        <td>${attCount ? `<strong>${attCount}</strong>` : `<span class="muted">0</span>`}</td>
        <td>${customFieldsDisplay || `<span class="muted">‚Äî</span>`}</td>
        <td>
          <div class="table-actions">
            ${t.estado !== "Cerrada"
              ? `<button class="secondary mini" data-act="close" type="button">Cerrar</button>`
              : `<button class="secondary mini" data-act="reopen" type="button">Reabrir</button>`}
            <button class="secondary mini" data-act="notify" type="button">Notificar</button>
          </div>
        </td>
        `;

          tr.addEventListener("dblclick", () => openEdit(t.id));

          const closeBtn = tr.querySelector('[data-act="close"]');
          if (closeBtn) closeBtn.addEventListener("click", () => quickClose(t.id));

          const reopenBtn = tr.querySelector('[data-act="reopen"]');
          if (reopenBtn) reopenBtn.addEventListener("click", () => quickReopen(t.id));

          const notifyBtn = tr.querySelector('[data-act="notify"]');
          if (notifyBtn) notifyBtn.addEventListener("click", (e) => {
            e.preventDefault(); e.stopPropagation();
            notifyByEmail(t.id);
          });

          tbody.appendChild(tr);
        }
      }

      function renderAllTasks() {
        const allTasksGrid = document.getElementById("allTasksGrid");
        allTasksGrid.innerHTML = "";

        // Get all tasks sorted by creation date (newest first)
        const allTasks = [...(state.tasks || [])].sort((a, b) => {
          const dateA = new Date(a.creada || 0).getTime();
          const dateB = new Date(b.creada || 0).getTime();
          return dateB - dateA;
        });

        if (allTasks.length === 0) {
          allTasksGrid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1; padding: 40px; text-align: center; color: var(--muted);">No hay tareas para mostrar</div>`;
          return;
        }

        // Create columns for each status
        for (const status of STATUSES) {
          const col = document.createElement("div");
          col.className = "all-tasks-col";
          col.dataset.status = status;

          const hd = document.createElement("div");
          hd.className = "all-col-hd";
          const statusTasks = allTasks.filter(t => t.estado === status);
          hd.innerHTML = `<div class="name">${escapeHtml(status)} <span class="badge">${statusTasks.length}</span></div>`;
          col.appendChild(hd);

          const tasksContainer = document.createElement("div");
          tasksContainer.className = "all-col-tasks";

          for (const task of statusTasks) {
            const wsName = workspaceNameById(task.workspace_id);
            const cardHtml = `
              <div class="all-task-card" data-id="${task.id}" data-status="${escapeHtml(task.estado)}">
                <div class="id-badge">#${task.id}</div>
                <div class="title">${escapeHtml(task.nombre)}</div>
                <div class="workspace" style="color: var(--muted); font-size: 12px; margin-bottom: 8px;">üìÅ ${escapeHtml(wsName || "Sin espacio")}</div>
                ${task.descripcion ? `<div style="font-size: 12px; color: var(--text); margin-bottom: 8px; line-height: 1.4; max-height: 60px; overflow: hidden;">${escapeHtml(task.descripcion)}</div>` : ""}
                <div style="font-size: 11px; color: var(--muted); margin-top: auto; padding-top: 8px; border-top: 1px solid rgba(0,0,0,.05);">
                  ${task.fechaTermino ? `<div style="margin-bottom: 4px;">‚è∞ ${escapeHtml(normalizeDueString(task.fechaTermino))}</div>` : ""}
                  <div>üìÖ ${fmtDateTimeCL(task.creada)}</div>
                </div>
              </div>
            `;

            const div = document.createElement("div");
            div.innerHTML = cardHtml;
            const card = div.firstElementChild;

            // Event listeners
            card.addEventListener("dblclick", () => openEdit(task.id));
            card.addEventListener("click", (e) => {
              e.stopPropagation();
            });

            tasksContainer.appendChild(card);
          }

          col.appendChild(tasksContainer);
          allTasksGrid.appendChild(col);
        }
      }

      function openTaskModal() {
        modalBackdrop.classList.add("show");
      }

      function closeTaskModal() {
        modalBackdrop.classList.remove("show");
        createRequestId = null;

        // Limpiar datepickers de campos personalizados
        Object.values(fieldDatePickers).forEach(fp => {
          if (fp && fp.destroy) fp.destroy();
        });
        fieldDatePickers = {};
      }

      function resetAttachmentsUI() {
        pendingFiles = [];
        if (f_files) f_files.value = "";
        filePendingInfo.textContent = "";
      }

      function renderAttachmentsUI(task) {
        const arr = (task && Array.isArray(task.adjuntos)) ? task.adjuntos : [];
        attachCount.textContent = String(arr.length);
        attachList.innerHTML = "";

        if (arr.length === 0) {
          attachList.innerHTML = `<div class="small-note">Sin adjuntos.</div>`;
          return;
        }

        for (const a of arr) {
          const div = document.createElement("div");
          div.className = "attach-item";

          // Detectar si es archivo .msg
          const fileName = String(a.name || "").toLowerCase();
          const isMsgFile = fileName.endsWith(".msg") ||
            String(a.mimeType || "").toLowerCase().includes("outlook") ||
            String(a.mimeType || "").toLowerCase() === "application/vnd.ms-outlook";

          // Crear enlace especial para archivos .msg
          let linkElement;
          if (isMsgFile) {
            // Para archivos .msg, crear un enlace que descargue y abra con Outlook
            linkElement = document.createElement("a");
            linkElement.href = escapeHtml(a.url || "#");
            linkElement.download = a.name || "archivo.msg";
            linkElement.textContent = escapeHtml(a.name || a.id || "Archivo");
            linkElement.style.cssText = `color: var(--accent); text-decoration: none; font-weight: 700; font-size: 12px;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 520px; display: inline-block; cursor: pointer;`;
            linkElement.title = "Hacer clic para abrir con Microsoft Outlook";
            // Al hacer clic, descargar√° el archivo y Windows lo abrir√° con Outlook si est√° instalado
            linkElement.addEventListener("click", (e) => {
              // Permitir que el navegador descargue el archivo
              // Windows autom√°ticamente lo abrir√° con Outlook si est√° configurado como predeterminado
            });
          } else {
            // Para otros archivos, comportamiento normal
            linkElement = document.createElement("a");
            linkElement.href = escapeHtml(a.url || "#");
            linkElement.target = "_blank";
            linkElement.rel = "noopener";
            linkElement.textContent = escapeHtml(a.name || a.id || "Archivo");
            linkElement.style.cssText = `color: var(--accent); text-decoration: none; font-weight: 700; font-size: 12px;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 520px; display: inline-block;`;
          }

          div.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:2px;">
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="secondary mini danger-btn" data-act="del" type="button">Eliminar</button>
        </div>
        `;

          const linkContainer = div.querySelector("div:first-child");
          linkContainer.appendChild(linkElement);
          const small = document.createElement("small");
          small.textContent = escapeHtml(a.mimeType || "");
          linkContainer.appendChild(small);

          div.querySelector('[data-act="del"]').addEventListener("click", async () => {
            if (!editingId) return;
            if (!confirm("¬øEliminar este adjunto?")) return;

            try {
              const res = await gs("deleteTaskAttachment", editingId, a.id);
              if (!res || !res.ok) { alert("No se pudo eliminar adjunto."); return; }
              const updated = Array.isArray(res.data) ? res.data : [];
              const t = state.tasks.find(x => x.id === editingId);
              if (t) t.adjuntos = updated;
              renderAttachmentsUI(t);
              renderAll();
            } catch (err) {
              alert("Error eliminando adjunto: " + (err?.message || err));
            }
          });

          attachList.appendChild(div);
        }
      }

      function renderPendingFilesInfo() {
        if (!pendingFiles || pendingFiles.length === 0) {
          filePendingInfo.textContent = "";
          return;
        }
        const totalBytes = pendingFiles.reduce((s, f) => s + (f.size || 0), 0);
        const mb = (totalBytes / (1024 * 1024)).toFixed(2);
        filePendingInfo.textContent = `Archivos seleccionados para subir: ${pendingFiles.length} ¬∑ Total aprox: ${mb}
        MB`;
      }

      async function uploadPendingFiles(taskId) {
        const totalBytes = pendingFiles.reduce((s, f) => s + (f.size || 0), 0);
        if (totalBytes > 20 * 1024 * 1024) {
          alert("Los adjuntos seleccionados superan 20 MB en total. Reduce el tama√±o y reintenta.");
          return [];
        }
        for (const f of pendingFiles) {
          if ((f.size || 0) > 10 * 1024 * 1024) {
            alert(`El archivo "${f.name}" supera 10 MB. Reduce el tama√±o y reintenta.`);
            return [];
          }
        }

        const payload = await Promise.all(pendingFiles.map(fileToPayload));
        const res = await gs("uploadTaskAttachments", taskId, payload);
        if (!res || !res.ok) throw new Error(res?.error || "No se pudo subir adjuntos");
        const updated = Array.isArray(res.data) ? res.data : [];

        resetAttachmentsUI();
        return updated;
      }

      function fileToPayload(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onerror = () => reject(new Error("No se pudo leer archivo: " + file.name));
          reader.onload = () => {
            const result = String(reader.result || "");
            const idx = result.indexOf("base64,");
            const b64 = idx >= 0 ? result.substring(idx + 7) : "";
            resolve({ name: file.name, mimeType: file.type || "application/octet-stream", dataBase64: b64 });
          };
          reader.readAsDataURL(file);
        });
      }

      function makeUUID() {
        if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
          const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      async function filesToPayload(files) {
        return Promise.all(Array.from(files || []).map(fileToPayload));
      }

      function openCreate() {
        dialogMode = "create";
        editingId = null;
        createRequestId = makeUUID();

        dlgTitle.textContent = "Crear tarea";
        dlgSub.textContent = "Se guarda en Supabase Cloud.";
        btnDeleteTask.style.display = "none";

        populateWorkspaceSelect(state.currentWorkspaceId);

        f_name.value = "";
        f_resp.value = "";
        f_desc.value = "";
        f_status.value = "Pendiente";

        setDueValue("");
        f_closedAt.value = "";
        f_meta.textContent = "";

        if (f_notifyOnSave) f_notifyOnSave.checked = false;

        resetAttachmentsUI();
        renderAttachmentsUI({ adjuntos: [] });
        renderCustomFieldsInTaskModal();

        openTaskModal();
        setTimeout(() => f_name.focus(), 50);
      }

      function openEdit(id) {
        const t = state.tasks.find(x => x.id === id);
        if (!t) return;

        dialogMode = "edit";
        editingId = id;
        createRequestId = null;

        dlgTitle.textContent = `Editar tarea #${t.id}`;
        dlgSub.textContent = t.nombre;
        btnDeleteTask.style.display = "inline-flex";

        populateWorkspaceSelect(t.workspaceId || state.currentWorkspaceId);

        f_name.value = t.nombre;
        f_resp.value = t.responsableEmail || "";
        f_desc.value = t.descripcion;
        f_status.value = t.estado;

        setDueValue(t.fechaTermino || "");

        f_closedAt.value = t.fechaCierre ? fmtDateTimeCL(t.fechaCierre) : "";
        f_meta.textContent = `Creaci√≥n: ${fmtDateTimeCL(t.creada)} | √öltima modificaci√≥n:
        ${fmtDateTimeCL(t.modificada)}`;

        if (f_notifyOnSave) f_notifyOnSave.checked = false;

        resetAttachmentsUI();
        renderAttachmentsUI(t);
        renderCustomFieldsInTaskModal(t);

        openTaskModal();
        setTimeout(() => f_name.focus(), 50);
      }

      async function moveTaskToWorkspace(taskId, targetWorkspaceId) {
        // taskId es n√∫mero, targetWorkspaceId puede ser n√∫mero o UUID string
        const tId = Number(taskId);
        
        console.log("moveTaskToWorkspace: tId=", tId, "targetWorkspaceId=", targetWorkspaceId);
        
        if (isNaN(tId)) {
          console.error("ID de tarea inv√°lido:", taskId);
          return;
        }
        
        const t = state.tasks.find(x => x.id === tId);
        if (!t) {
          console.error("Tarea no encontrada:", tId);
          return;
        }
        
        // Comparar workspaceId como strings (puede ser UUID o n√∫mero como string)
        const wsId = String(targetWorkspaceId);
        const currentWsId = String(t.workspaceId);
        
        if (currentWsId === wsId) {
          console.log("Tarea ya en este workspace");
          return;
        }
        
        const ws = state.workspaces.find(x => String(x.id) === wsId);
        if (!ws) {
          console.error("Workspace no encontrado:", wsId);
          return;
        }
        
        // Pedir confirmaci√≥n si la tarea est√° cerrada
        if (t.estado === "Cerrada") {
          if (!confirm(`¬øMover tarea cerrada "#${t.id}" a "${ws.nombre}"?`)) return;
        }

        const nowIso = new Date().toISOString();
        const updated = { ...t, workspaceId: wsId, modificada: nowIso };

        try {
          const res = await gs("upsertTarea", updated);
          if (!res || !res.ok) {
            alert("No se pudo mover la tarea.");
            return;
          }
          const saved = res.data;
          saved.adjuntos = Array.isArray(saved.adjuntos) ? saved.adjuntos : (t.adjuntos || []);
          state.tasks = state.tasks.map(x => x.id === saved.id ? saved : x);
          
          // Registrar cambio en historial
          const oldWsName = workspaceNameById(t.workspaceId);
          logChange(tId, "workspace", t.workspaceId, wsId, `${oldWsName} ‚Üí ${ws.nombre}`);
          
          console.log("Tarea movida a workspace", ws.nombre);
          renderAll();
          renderSidebar();
        } catch (err) {
          alert("Error moviendo tarea: " + (err?.message || err));
        }
      }

      // Funci√≥n para registrar cambios en el historial
      function logChange(taskId, changeType, oldValue, newValue, details = "") {
        const entry = {
          id: Date.now(),
          taskId: taskId,
          type: changeType, // "status", "workspace", "other"
          oldValue: oldValue,
          newValue: newValue,
          timestamp: new Date().toISOString(),
          details: details
        };
        state.changelog.push(entry);
        console.log("üìù Cambio registrado:", entry);
        // Mantener solo los √∫ltimos 500 cambios
        if (state.changelog.length > 500) {
          state.changelog = state.changelog.slice(-500);
        }
      }

      async function moveTaskToStatus(id, status) {
        const tId = Number(id);
        console.log("moveTaskToStatus: tId=", tId, "status=", status);
        
        if (isNaN(tId)) {
          console.error("ID inv√°lido:", id);
          return;
        }
        
        const t = state.tasks.find(x => x.id === tId);
        if (!t) {
          console.error("Tarea no encontrada:", tId);
          return;
        }
        if (t.estado === status) {
          console.log("Tarea ya tiene este estado");
          return;
        }
        
        if (!STATUSES.includes(status)) {
          console.error("Estado inv√°lido:", status);
          return;
        }
        
        // Pedir confirmaci√≥n si la tarea es cr√≠tica (Cerrada o cambio importante)
        if (t.estado === "Cerrada" || (t.estado !== "Por Hacer" && status !== "Por Hacer")) {
          if (!confirm(`Cambiar "#${t.id}" de "${t.estado}" a "${status}"?`)) return;
        }

        const nowIso = new Date().toISOString();
        const prev = t.estado;

        const updated = { ...t, estado: status, modificada: nowIso };
        if (status === "Cerrada" && !updated.fechaCierre) updated.fechaCierre = nowIso;
        if (status !== "Cerrada" && prev === "Cerrada") updated.fechaCierre = "";

        try {
          const res = await gs("upsertTarea", updated);
          if (!res || !res.ok) {
            alert("No se pudo cambiar el estado: " + (res?.error || "Error desconocido"));
            return;
          }
          const saved = res.data;
          saved.adjuntos = Array.isArray(saved.adjuntos) ? saved.adjuntos : (t.adjuntos || []);
          state.tasks = state.tasks.map(x => x.id === saved.id ? saved : x);
          
          // Registrar cambio en historial
          logChange(tId, "status", prev, status, `${prev} ‚Üí ${status}`);
          
          console.log("Tarea movida a estado", status);
          renderAll();
        } catch (err) {
          alert("Error: " + (err?.message || err));
        }
      }
      function quickClose(id) { return moveTaskToStatus(id, "Cerrada"); }
      function quickReopen(id) { return moveTaskToStatus(id, "Pendiente"); }

      // ===== Fecha t√©rmino con hora =====
      function initDuePicker() {
        if (!window.flatpickr) {
          f_dueDateDisplay.readOnly = false;
          f_dueDateDisplay.placeholder = "DD-MM-YYYY HH:mm";
          btnDueOpen.disabled = true;
          return;
        }

        fpDue = flatpickr(f_dueDateDisplay, {
          enableTime: true,
          time_24hr: true,
          minuteIncrement: 5,
          allowInput: false,
          clickOpens: false,
          disableMobile: true,
          dateFormat: "d-m-Y H:i",
          static: true,
          onChange: (selectedDates) => {
            if (selectedDates && selectedDates[0]) {
              const d = selectedDates[0];
              f_dueDate.value = d.toISOString();
              f_dueDateDisplay.value = formatDMYHM(d);
            } else {
              f_dueDate.value = "";
              f_dueDateDisplay.value = "";
            }
          }
        });

        btnDueOpen.addEventListener("click", () => fpDue.open());
        f_dueDateDisplay.addEventListener("click", () => fpDue.open());
      }

      function setDueValue(dueStr) {
        const s = (dueStr || "").trim();
        if (!s) {
          f_dueDate.value = "";
          f_dueDateDisplay.value = "";
          if (fpDue) fpDue.clear();
          return;
        }

        const d = parseDueDate(s);
        if (!d) {
          f_dueDate.value = s;
          f_dueDateDisplay.value = s;
          if (fpDue) fpDue.clear();
          return;
        }

        const norm = formatDMYHM(d);
        f_dueDate.value = d.toISOString();
        f_dueDateDisplay.value = norm;
        if (fpDue) fpDue.setDate(d, false);
      }

      function normalizeDueString(s) {
        const d = parseDueDate(s);
        return d ? formatDMYHM(d) : String(s || "");
      }

      function parseDueDate(s) {
        if (!s) return null;
        const str = String(s).trim();

        let m = str.match(/^(\d{2})-(\d{2})-(\d{4})[ T](\d{2}):(\d{2})$/);
        if (m) {
          const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
          const hh = Number(m[4]), mi = Number(m[5]);
          const d = new Date(yy, mm - 1, dd, hh, mi, 0, 0);
          return isNaN(d.getTime()) ? null : d;
        }

        m = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (m) {
          const yy = Number(m[1]), mm = Number(m[2]), dd = Number(m[3]);
          const d = new Date(yy, mm - 1, dd, 0, 0, 0, 0);
          return isNaN(d.getTime()) ? null : d;
        }

        const d2 = new Date(str);
        return isNaN(d2.getTime()) ? null : d2;
      }

      function formatDMYHM(d) {
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2, "0");
        const mi = String(d.getMinutes()).padStart(2, "0");
        return `${dd}-${mm}-${yy} ${hh}:${mi}`;
      }

      // ===== Export XLSX =====
      function exportXLSX() {
        if (!window.XLSX) {
          alert("No se pudo cargar la librer√≠a XLSX.");
          return;
        }

        const rows = getFilteredTasks();
        const wsName = workspaceNameById(state.currentWorkspaceId);

        const headers = [
          "ID",
          "Espacio de trabajo",
          "Nombre",
          "Descripci√≥n",
          "Responsable",
          "Estado",
          "Creaci√≥n",
          "Revisi√≥n/Modificaci√≥n",
          "Fecha t√©rmino",
          "Fecha cierre",
          "Adjuntos (links)"
        ];

        // Agregar headers de campos personalizados
        if (state.customFields && state.customFields.length > 0) {
          state.customFields.forEach(field => {
            headers.push(field.name);
          });
        }

        headers.push("Acciones");

        const aoa = [headers];

        for (const t of rows) {
          const links = (Array.isArray(t.adjuntos) && t.adjuntos.length)
            ? t.adjuntos.map(a => `${a.name}: ${a.url}`).join("\n")
            : "";

          const rowData = [
            t.id || "",
            wsName || "",
            t.nombre || "",
            t.descripcion || "",
            responsibleDisplay(t) || "",
            t.estado || "",
            fmtDateTimeCL(t.creada) || "",
            fmtDateTimeCL(t.modificada) || "",
            t.fechaTermino ? normalizeDueString(t.fechaTermino) : "",
            t.fechaCierre ? fmtDateTimeCL(t.fechaCierre) : "",
            links
          ];

          // Agregar valores de campos personalizados
          if (state.customFields && state.customFields.length > 0) {
            state.customFields.forEach(field => {
              const value = t.customFields && t.customFields[field.id] !== undefined ?
                getExcelFieldValue(field, t.customFields[field.id]) : "";
              rowData.push(value);
            });
          }

          rowData.push(""); // Columna acciones vac√≠a para Excel

          aoa.push(rowData);
        }

        const ws = XLSX.utils.aoa_to_sheet(aoa);
        ws["!cols"] = computeColWidths(aoa);

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Tareas");

        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        const blob = new Blob([wbout], {
          type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        });

        downloadBlob(blob, `tareas_${sanitizeFile(wsName || "workspace")}.xlsx`);
      }

      function getExcelFieldValue(field, value) {
        if (!value && value !== 0) return "";

        switch (field.type) {
          case 'date':
            try {
              const date = new Date(value);
              return isNaN(date.getTime()) ? value : formatDMY(date);
            } catch (e) {
              return value;
            }

          case 'number':
            return isNaN(parseFloat(value)) ? value : parseFloat(value);

          default:
            return String(value);
        }
      }

      function computeColWidths(aoa) {
        const colCount = Math.max(...aoa.map(r => r.length));
        const widths = new Array(colCount).fill(10).map(() => ({ wch: 12 }));

        for (let c = 0; c < colCount; c++) {
          let maxLen = 10; for (let r = 0; r < aoa.length; r++) {
            const v = aoa[r][c];
            const s = (v === null || v === undefined) ? "" : String(v); if (s.length > maxLen) maxLen = s.length;
          }
          widths[c] = { wch: Math.min(Math.max(maxLen + 2, 12), 70) };
        }
        return widths;
      }

      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function sanitizeFile(name) {
        return String(name).replace(/[\\\/:*?"<>|]+/g, "_").trim() || "archivo";
      }

      // ===== Due pill =====
      function getDuePill(t) {
        if (!t.fechaTermino) return `<span class="pill">T√©rmino: ‚Äî</span>`;

        const due = parseDueDate(t.fechaTermino);
        if (!due) return `<span class="pill">T√©rmino: ${escapeHtml(String(t.fechaTermino))}</span>`;

        const now = Date.now();
        const diffHrs = Math.round((due.getTime() - now) / (1000 * 60 * 60));

        if (String(t.estado) === "Cerrada") return `<span class="pill ok">T√©rmino: ${formatDMYHM(due)}</span>`;
        if (diffHrs < 0) return `<span class="pill danger">Vencida: ${formatDMYHM(due)}</span>`;
        if (diffHrs <= 48) return `<span class="pill warn">Pr√≥x: ${formatDMYHM(due)}</span>`;
        return `<span class="pill">T√©rmino: ${formatDMYHM(due)}</span>`;
      }

      // ===== NOTIFICAR (mailto) =====
      function openMailto(to, subject, body) {
        const mailtoUrl =
          `mailto:${encodeURIComponent(to)}` +
          `?subject=${encodeURIComponent(subject)}` +
          `&body=${encodeURIComponent(body)}`;

        const a = document.createElement("a");
        a.href = mailtoUrl;
        a.style.display = "none";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      function notifyByEmail(taskId) {
        const t = state.tasks.find(x => x.id === taskId);
        if (!t) return;

        const to = String(t.responsableEmail || "").trim();
        if (!to) {
          alert("Esta tarea no tiene Responsable (correo) asignado.");
          return;
        }

        const wsName = workspaceNameById(t.workspaceId || state.currentWorkspaceId) || "";
        const due = t.fechaTermino ? normalizeDueString(t.fechaTermino) : "‚Äî";
        const att = (Array.isArray(t.adjuntos) && t.adjuntos.length)
          ? t.adjuntos.map(a => `- ${a.name}: ${a.url}`).join("\n")
          : "(sin adjuntos)";

        // Campos personalizados en notificaci√≥n
        let customFieldsText = "";
        if (t.customFields && state.customFields) {
          const fieldsWithValues = state.customFields.filter(field =>
            t.customFields[field.id] !== undefined && t.customFields[field.id] !== ''
          );

          if (fieldsWithValues.length > 0) {
            customFieldsText = "\n\nCampos Personalizados:\n" + fieldsWithValues.map(field => {
              const value = t.customFields[field.id];
              let displayValue = String(value);

              if (field.type === 'date') {
                try {
                  const date = new Date(value);
                  displayValue = isNaN(date.getTime()) ? value : formatDMY(date);
                } catch (e) {
                  displayValue = value;
                }
              }

              return `- ${field.name}: ${displayValue}`;
            }).join("\n");
          }
        }

        const subject = `Tarea #${t.id} (${wsName || "Sin espacio"}): ${t.nombre}`;

        const bodyLines = [
          `Hola ${(t.responsableNombre || "").trim() || ""}`.trim() + ",",
          "",
          "Te notifico la siguiente tarea:",
          `- ID: ${t.id}`,
          `- Espacio: ${wsName || "‚Äî"}`,
          `- Nombre: ${t.nombre || "‚Äî"}`,
          `- Descripci√≥n: ${t.descripcion || "‚Äî"}`,
          `- Estado: ${t.estado || "‚Äî"}`,
          `- Fecha t√©rmino: ${due}`,
          "",
          "Adjuntos:",
          att,
          customFieldsText,
          "",
          `Creaci√≥n: ${fmtDateTimeCL(t.creada) || "‚Äî"}`,
          `√öltima modificaci√≥n: ${fmtDateTimeCL(t.modificada) || "‚Äî"}`,
          "",
          "Saludos,",
          "",
          "Victor Espinoza Concha",
          "Gerente de Producci√≥n y Log√≠stica"
        ];

        openMailto(to, subject, bodyLines.join("\n"));
      }

      function notifyByEmailDraft(d) {
        const to = String(d.responsableEmail || "").trim();
        if (!to) {
          alert("No se puede notificar: falta Responsable (correo).");
          return;
        }

        const wsName = String(d.workspaceName || "").trim();
        const due = d.fechaTermino ? normalizeDueString(d.fechaTermino) : "‚Äî";
        const idTxt = String(d.id || "NUEVA");

        // Campos personalizados en notificaci√≥n de borrador
        let customFieldsText = "";
        if (d.customFields && state.customFields) {
          const fieldsWithValues = state.customFields.filter(field =>
            d.customFields[field.id] !== undefined && d.customFields[field.id] !== ''
          );

          if (fieldsWithValues.length > 0) {
            customFieldsText = "\n\nCampos Personalizados:\n" + fieldsWithValues.map(field => {
              const value = d.customFields[field.id];
              let displayValue = String(value);

              if (field.type === 'date') {
                try {
                  const date = new Date(value);
                  displayValue = isNaN(date.getTime()) ? value : formatDMY(date);
                } catch (e) {
                  displayValue = value;
                }
              }

              return `- ${field.name}: ${displayValue}`;
            }).join("\n");
          }
        }

        const subject = `Tarea #${idTxt} (${wsName || "Sin espacio"}): ${d.nombre || ""}`.trim();

        const bodyLines = [
          `Hola ${(d.responsableNombre || "").trim() || ""}`.trim() + ",",
          "",
          "Te notifico la siguiente tarea (borrador):",
          `- ID: ${idTxt} (si es NUEVA, el ID final se asigna al guardar)`,
          `- Espacio: ${wsName || "‚Äî"}`,
          `- Nombre: ${d.nombre || "‚Äî"}`,
          `- Descripci√≥n: ${d.descripcion || "‚Äî"}`,
          `- Estado: ${d.estado || "‚Äî"}`,
          `- Fecha t√©rmino: ${due}`,
          customFieldsText,
          "",
          "Saludos,",
          "",
          "Victor Espinoza Concha",
          "Gerente de Producci√≥n y Log√≠stica"
        ];

        openMailto(to, subject, bodyLines.join("\n"));
      }

      function fmtDateTimeCL(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "";
        const parts = new Intl.DateTimeFormat("es-CL", {
          timeZone: TZ_CL,
          year: "numeric", month: "2-digit", day: "2-digit",
          hour: "2-digit", minute: "2-digit",
          hour12: false
        }).formatToParts(d).reduce((acc, p) => { acc[p.type] = p.value; return acc; }, {});
        return `${parts.day}-${parts.month}-${parts.year} ${parts.hour}:${parts.minute}`;
      }

      function escapeHtml(str) {
        return String(str ?? "").replace(/[&<>"']/g, (m) => ({
          "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
        }[m]));
      }

      function focusSearchHotkey() {
        document.addEventListener("keydown", (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
            e.preventDefault();
            searchEl.focus();
          }
        });
      }

      async function gs(fnName, ...args) {
        switch (fnName) {
          case "getBootstrap":
            return await supabaseService.getBootstrap();
          case "upsertWorkspace":
            return await supabaseService.upsertWorkspace(args[0]);
          case "upsertTarea":
            return await supabaseService.upsertTarea(args[0]);
          case "deleteTarea":
            return await supabaseService.deleteTarea(args[0]);
          case "upsertResponsable":
            return await supabaseService.upsertResponsable(args[0]);
          case "setResponsableActive":
            return await supabaseService.setResponsableActive(args[0], args[1]);
          case "upsertCustomField":
            return await supabaseService.upsertCustomField(args[0]);
          case "deleteCustomField":
            return await supabaseService.deleteCustomField(args[0]);
          case "uploadTaskAttachments":
            return await supabaseService.uploadTaskAttachments(args[0], args[1]);
          case "deleteTaskAttachment":
            return await supabaseService.deleteTaskAttachment(args[0], args[1]);
          case "deleteWorkspace":
            return await supabaseService.deleteWorkspace(args[0]);
          case "moveTasksToWorkspace":
            return await supabaseService.moveTasksToWorkspace(args[0], args[1]);
          default:
            console.warn(`Funci√≥n ${fnName} no implementada en SupabaseService`);
            return { ok: false, error: "No implementado" };
        }
      }

      const supabaseService = {
        async getBootstrap() {
          try {
            const { data: workspaces, error: wsErr } = await _supabase.from('workspaces').select('*');
            if (wsErr) throw wsErr;

            const { data: responsables, error: respErr } = await _supabase.from('responsables').select('*');
            if (respErr) throw respErr;

            const { data: tareas, error: tErr } = await _supabase.from('tareas').select('*').order('id', {
              ascending: false
            });
            if (tErr) throw tErr;

            let customFields = [];
            try {
              const { data, error: cfErr } = await _supabase.from('custom_fields').select('*').order('order');
              if (!cfErr && data) customFields = data;
            } catch (err) {
              // Silenciosamente ignorar errores de custom_fields (tabla opcional)
              // console.error("Error trayendo custom_fields:", err);
            }

            return {
              ok: true,
              workspaces: (workspaces || []).map(w => ({ ...w, id: w.id })),
              responsables: responsables || [],
              tareas: (tareas || []).map(t => ({
                ...t,
                workspaceId: t.workspace_id,
                responsableEmail: t.responsable_email,
                fechaTermino: t.fecha_termino,
                fechaCierre: t.fecha_cierre,
                customFields: t.custom_fields,
                clientRequestId: t.client_request_id,
                adjuntos: Array.isArray(t.adjuntos) ? t.adjuntos : []
              })),
              customFields: customFields
            };
          } catch (err) {
            console.error("Bootstrap error:", err);
            return { ok: false, error: err.message };
          }
        },

        async upsertWorkspace(ws) {
          const payload = {
            nombre: ws.nombre,
            activo: ws.activo !== false
          };
          if (ws.id) {
            payload.id = ws.id;
          }

          const { data, error } = await _supabase
            .from('workspaces')
            .upsert(payload)
            .select()
            .single();

          return { ok: !error, data: data, error: error?.message };
        },

        async upsertTarea(task) {
          console.log("SupabaseService.upsertTarea - Input:", task);
          const payload = {
            workspace_id: task.workspaceId,
            nombre: task.nombre,
            descripcion: task.descripcion,
            responsable_email: task.responsableEmail || null,
            estado: task.estado,
            creada: task.creada,
            modificada: task.modificada,
            fecha_termino: task.fechaTermino || null,
            fecha_cierre: task.fechaCierre || null,
            custom_fields: task.customFields || {},
            client_request_id: task.clientRequestId,
            adjuntos: task.adjuntos || []
          };
          if (task.id && task.id !== 0) payload.id = task.id;
          console.log("SupabaseService.upsertTarea - Payload:", payload);

          const { data, error } = await _supabase
            .from('tareas')
            .upsert(payload, { onConflict: 'client_request_id' })
            .select()
            .single();

          if (error) {
            console.error("SupabaseService.upsertTarea - Error:", error);
            return { ok: false, error: error.message };
          }

          console.log("SupabaseService.upsertTarea - Success:", data);
          return {
            ok: true,
            data: {
              ...data,
              workspaceId: data.workspace_id,
              responsableEmail: data.responsable_email,
              fechaTermino: data.fecha_termino,
              fechaCierre: data.fecha_cierre,
              customFields: data.custom_fields,
              clientRequestId: data.client_request_id,
              adjuntos: data.adjuntos || []
            }
          };
        },

        async deleteTarea(id) {
          const { error } = await _supabase.from('tareas').delete().eq('id', id);
          return { ok: !error, id: id, error: error?.message };
        },

        async upsertResponsable(resp) {
          const { data, error } = await _supabase
            .from('responsables')
            .upsert({ email: resp.email, nombre: resp.nombre, activo: resp.activo !== false })
            .select()
            .single();
          return { ok: !error, data: data, error: error?.message };
        },

        async setResponsableActive(email, active) {
          const { data, error } = await _supabase
            .from('responsables')
            .update({ activo: !!active })
            .eq('email', email)
            .select()
            .single();
          return { ok: !error, data: data, error: error?.message };
        },

        async upsertCustomField(field) {
          const { data, error } = await _supabase
            .from('custom_fields')
            .upsert({ id: field.id, name: field.name, type: field.type, order: field.order })
            .select()
            .single();
          return { ok: !error, data: data, error: error?.message };
        },

        async deleteCustomField(id) {
          const { error } = await _supabase.from('custom_fields').delete().eq('id', id);
          return { ok: !error, error: error?.message };
        },

        async uploadTaskAttachments(taskId, files) {
          try {
            const added = [];
            for (const f of files) {
              const originalName = f.name;
              const mimeType = f.mimeType;
              const b64 = f.dataBase64;

              // Sanitizar nombre de archivo para Supabase Storage
              const sanitizedName = originalName
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remover acentos
                .replace(/[^a-zA-Z0-9._-]/g, '_') // Reemplazar caracteres especiales con _
                .replace(/_+/g, '_') // Evitar m√∫ltiples guiones bajos seguidos
                .replace(/^_|_$/g, ''); // Remover guiones bajos al inicio/final

              const byteCharacters = atob(b64);
              const byteNumbers = new Array(byteCharacters.length);
              for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
              }
              const byteArray = new Uint8Array(byteNumbers);
              const blob = new Blob([byteArray], { type: mimeType });

              const path = `${taskId}/${Date.now()}_${sanitizedName}`;
              const { data, error } = await _supabase.storage
                .from('task-attachments')
                .upload(path, blob);

              if (error) throw error;

              const { data: { publicUrl } } = _supabase.storage
                .from('task-attachments')
                .getPublicUrl(path);

              added.push({
                id: data.path,
                name: originalName,
                url: publicUrl,
                mimeType: mimeType,
                created: new Date().toISOString()
              });
            }

            const { data: task, error: getErr } = await _supabase
              .from('tareas')
              .select('adjuntos')
              .eq('id', taskId)
              .single();

            if (getErr) throw getErr;

            const currentAdj = Array.isArray(task.adjuntos) ? task.adjuntos : [];
            const merged = currentAdj.concat(added);

            const { error: updErr } = await _supabase
              .from('tareas')
              .update({ adjuntos: merged })
              .eq('id', taskId);

            if (updErr) throw updErr;

            return { ok: true, data: merged };
          } catch (err) {
            console.error("Upload error:", err);
            if (err.message && err.message.includes("not found")) {
              try {
                const { data: buckets } = await _supabase.storage.listBuckets();
                console.log("Buckets disponibles en tu Supabase:", buckets.map(b => b.name));
              } catch (e) { }
            }
            return { ok: false, error: err.message };
          }
        },

        async deleteTaskAttachment(taskId, fileId) {
          try {
            const { error: delErr } = await _supabase.storage
              .from('task-attachments')
              .remove([fileId]);

            if (delErr) console.warn("Error eliminando archivo f√≠sico:", delErr);

            const { data: task, error: getErr } = await _supabase
              .from('tareas')
              .select('adjuntos')
              .eq('id', taskId)
              .single();

            if (getErr) throw getErr;

            const currentAdj = Array.isArray(task.adjuntos) ? task.adjuntos : [];
            const remaining = currentAdj.filter(a => a.id !== fileId);

            const { error: updErr } = await _supabase
              .from('tareas')
              .update({ adjuntos: remaining })
              .eq('id', taskId);

            if (updErr) throw updErr;

            return { ok: true, data: remaining };
          } catch (err) {
            console.error("Delete attachment error:", err);
          }
        },
        async deleteWorkspace(id) {
          const { error } = await _supabase.from('workspaces').delete().eq('id', id);
          return { ok: !error, id: id, error: error?.message };
        },
        async moveTasksToWorkspace(sourceWsId, targetWsId) {
          const { error } = await _supabase.from('tareas').update({ workspace_id: targetWsId }).eq('workspace_id', sourceWsId);
          return { ok: !error, error: error?.message };
        }
      };

      /* ==== responsables ==== */
      function openRespModal() {
        respBackdrop.classList.add("show"); r_name.value = ""; r_email.value =
          ""; r_email.disabled = false; renderResponsablesTable(); setTimeout(() => r_name.focus(), 50);
      }
      function closeRespModal() {
        respBackdrop.classList.remove("show"); populateResponsibleSelect();
        renderSidebar(); renderAll();
      }

      function renderResponsablesTable() {
        respTbody.innerHTML = "";
        const rows = [...state.responsables].sort((a, b) => {
          if ((a.activo !== false) !== (b.activo !== false)) return (a.activo !== false) ? -1 : 1;
          return (a.nombre || a.email).localeCompare(b.nombre || b.email, "es");
        });

        for (const r of rows) {
          const tr = document.createElement("tr");
          const pill = (r.activo !== false)
            ? `<span class="pill ok">‚óè Activo</span>`
            : `<span class="pill warn">‚óè Inactivo</span>`;

          tr.innerHTML = `
                      <td style="padding:10px; border-bottom:1px solid var(--border);">${escapeHtml(r.nombre || "")}
                      </td>
                      <td style="padding:10px; border-bottom:1px solid var(--border);">${escapeHtml(r.email || "")}</td>
                      <td style="padding:10px; border-bottom:1px solid var(--border);">${pill}</td>
                      <td style="padding:10px; border-bottom:1px solid var(--border);">
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                          <button class="secondary mini" data-act="edit" type="button">Editar</button>
                          ${(r.activo !== false)
              ? `<button class="secondary mini" data-act="off" type="button">Desactivar</button>`
              : `<button class="secondary mini" data-act="on" type="button">Activar</button>`}
                        </div>
                      </td>
                      `;

          tr.querySelector('[data-act="edit"]').addEventListener("click", () => {
            r_name.value = r.nombre || "";
            r_email.value = r.email || "";
            r_email.disabled = true;
            r_name.focus();
          });

          const off = tr.querySelector('[data-act="off"]');
          if (off) off.addEventListener("click", async () => { await setRespActive(r.email, false); });

          const on = tr.querySelector('[data-act="on"]');
          if (on) on.addEventListener("click", async () => { await setRespActive(r.email, true); });

          respTbody.appendChild(tr);
        }
      }

      async function saveResponsableFlow() {
        const nombre = (r_name.value || "").trim();
        const email = (r_email.value || "").trim().toLowerCase();
        if (!nombre) { alert("Nombre requerido."); return; }
        if (!email) { alert("Email requerido."); return; }

        try {
          const res = await gs("upsertResponsable", { nombre, email, activo: true });
          if (!res || !res.ok) throw new Error("No se pudo guardar responsable");

          const saved = res.data;
          const idx = state.responsables.findIndex(x => x.email === saved.email);
          if (idx >= 0) state.responsables[idx] = saved;
          else state.responsables = [saved, ...state.responsables];

          r_name.value = "";
          r_email.value = "";
          r_email.disabled = false;

          renderResponsablesTable();
        } catch (err) {
          alert("Error guardando responsable: " + (err && err.message ? err.message : err));
        }
      }

      async function setRespActive(email, active) {
        try {
          const res = await gs("setResponsableActive", email, active);
          if (!res || !res.ok) throw new Error("No se pudo cambiar estado");
          const idx = state.responsables.findIndex(x => x.email === String(email).toLowerCase());
          if (idx >= 0) state.responsables[idx].activo = !!active;
          renderResponsablesTable();
        } catch (err) {
          alert("Error actualizando responsable: " + (err && err.message ? err.message : err));
        }
      }

      // Init
      initDuePicker();
      wireUI();
      focusSearchHotkey();
      bootstrap();
    })();
  </script>
</body>

</html>
